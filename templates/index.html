<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Pacifica Trading Bot - Dashboard v1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .log-line { font-family: monospace; font-size: 0.875rem; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }
        .log-debug { color: #6b7280; }
        .log-success { color: #10b981; }
        
        .pulse-dot { 
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .btn-disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        
        .metric-card {
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .trade-row-profit { background-color: rgba(16, 185, 129, 0.1); }
        .trade-row-loss { background-color: rgba(239, 68, 68, 0.1); }
        
        .ws-connected { color: #10b981; }
        .ws-disconnected { color: #ef4444; }
        
        .position-long { border-left: 4px solid #10b981; }
        .position-short { border-left: 4px solid #ef4444; }
        
        .order-buy { border-left: 4px solid #3b82f6; }
        .order-sell { border-left: 4px solid #f59e0b; }
        
        #logs-container::-webkit-scrollbar {
            width: 8px;
        }
        
        #logs-container::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        #logs-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        
        #logs-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Alertas Toast -->
    <div id="alerts-container"></div>
    
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Header -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold mb-2">ü§ñ Pacifica Trading Bot</h1>
                <p class="text-gray-400">Dashboard v1.1 - Configura√ß√µes R√°pidas + Auto-apply</p>
            </div>
            <div class="text-right">
                <div class="flex items-center gap-2 justify-end mb-2">
                    <span class="text-gray-400 text-sm">Auto-Refresh:</span>
                    <div id="refresh-status" class="flex items-center gap-2">
                        <span class="ws-connected">‚óè</span>
                        <span class="text-sm">Ativo (30s)</span>
                    </div>
                </div>
                <div class="text-sm text-gray-500" id="last-update">√öltima atualiza√ß√£o: -</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-4 mb-6 border-b border-gray-700 overflow-x-auto">
            <button onclick="showTab('dashboard')" id="tab-dashboard" 
                    class="px-4 py-2 border-b-2 border-blue-500 text-blue-500 whitespace-nowrap">
                üìä Dashboard
            </button>
            <button onclick="showTab('volume')" id="tab-volume" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                üí∞ Volume
            </button>
            <button onclick="showTab('trades')" id="tab-trades" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                üìã Hist√≥rico
            </button>
            <button onclick="showTab('logs')" id="tab-logs" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                üìú Logs
            </button>
            <button onclick="showTab('csv-analysis')" id="tab-csv-analysis" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                üìä An√°lise CSV
            </button>
            <button onclick="showTab('config')" id="tab-config" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                ‚öôÔ∏è Config
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="content-dashboard">
            <!-- Status Cards e Controles -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-800 rounded-lg p-6 metric-card">
                    <p class="text-gray-400 text-sm mb-2">Status</p>
                    <p id="status-text" class="text-2xl font-bold">üî¥ Parado</p>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 metric-card">
                    <p class="text-gray-400 text-sm mb-2">PNL Acumulado</p>
                    <p id="pnl-text" class="text-2xl font-bold">$0.00</p>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 metric-card">
                    <p class="text-gray-400 text-sm mb-2">Total Volume</p>
                    <p id="volume-text" class="text-2xl font-bold">$0</p>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 metric-card">
                    <p class="text-gray-400 text-sm mb-2">Controles</p>
                    <div class="flex gap-2 flex-wrap justify-center mt-3">
                        <button id="btn-start" onclick="startBot()" 
                                class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-sm font-semibold">
                            ‚ñ∂Ô∏è
                        </button>
                        <button id="btn-stop" onclick="stopBot(false)" disabled
                                class="bg-yellow-600 hover:bg-yellow-700 px-3 py-2 rounded text-sm font-semibold btn-disabled">
                            ‚è∏Ô∏è
                        </button>
                        <button id="btn-stop-force" onclick="stopBot(true)" disabled
                                class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-sm font-semibold btn-disabled">
                            üõë
                        </button>
                        <button id="btn-restart" onclick="restartBot()" disabled
                                class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm font-semibold btn-disabled">
                            üîÑ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resumo de Posi√ß√µes -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">üìä Resumo</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <p class="text-gray-400 text-sm mb-2">PNL N√£o Realizado</p>
                        <p id="unrealized-pnl" class="text-2xl font-bold">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm mb-2">PNL Realizado</p>
                        <p id="realized-pnl" class="text-2xl font-bold">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Exposi√ß√£o Total</p>
                        <p id="positions-exposure" class="text-2xl font-bold">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Ordens Pendentes</p>
                        <p id="orders-pending-value" class="text-2xl font-bold">$0.00</p>
                    </div>
                </div>
            </div>

            <!-- M√©tricas de Conta e Margem -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">üí∞ Saldo da Conta</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Saldo Total:</span>
                            <span id="account-balance" class="text-2xl font-bold text-blue-400">$0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">√öltima atualiza√ß√£o:</span>
                            <span id="balance-updated" class="text-gray-500">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">üìä Margem</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Margem Usada:</span>
                            <span id="margin-used" class="text-orange-400">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Margem Dispon√≠vel:</span>
                            <span id="margin-available" class="text-green-400">$0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">üéØ Utiliza√ß√£o</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-gray-400">Margem Livre:</span>
                                <span id="margin-free-percent" class="text-2xl font-bold text-green-400">0%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="margin-free-bar" class="bg-green-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 text-center">
                            <span id="margin-status-text">Monitorando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posi√ß√µes e Ordens -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Posi√ß√µes Ativas -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">üìà Posi√ß√µes Ativas</h2>
                        <span id="positions-count" class="bg-blue-600 px-3 py-1 rounded text-sm">0</span>
                    </div>
                    <div id="positions-container" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Nenhuma posi√ß√£o ativa</p>
                    </div>
                </div>
                
                <!-- Ordens Abertas -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">üìã Ordens Abertas</h2>
                        <span id="orders-count" class="bg-purple-600 px-3 py-1 rounded text-sm">0</span>
                    </div>
                    <div id="orders-container" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Nenhuma ordem aberta</p>
                    </div>
                </div>
            </div>

            <!-- System Info -->
            <div id="system-info" class="bg-gray-800 rounded-lg p-6 hidden">
                <h2 class="text-xl font-semibold mb-4">üíª Informa√ß√µes do Sistema</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <p class="text-gray-400 text-sm">PID</p>
                        <p id="pid-text" class="text-xl font-mono">-</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">CPU</p>
                        <p id="cpu-text" class="text-xl">0%</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Mem√≥ria</p>
                        <p id="memory-text" class="text-xl">0 MB</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Uptime</p>
                        <p id="uptime-text" class="text-xl">0m</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trades Tab -->
        <div id="content-trades" class="hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">üìã Hist√≥rico de Trades</h2>
                    <div class="flex gap-2">
                        <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded flex items-center gap-2">
                            üì• CSV
                        </button>
                        <button onclick="refreshTrades()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            üîÑ
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left">Data/Hora</th>
                                <th class="px-4 py-3 text-left">S√≠mbolo</th>
                                <th class="px-4 py-3 text-right">PNL USD</th>
                                <th class="px-4 py-3 text-right">PNL %</th>
                                <th class="px-4 py-3 text-right">Dura√ß√£o</th>
                                <th class="px-4 py-3 text-left">Motivo</th>
                                <th class="px-4 py-3 text-right">PNL Acum.</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table-body" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                    Carregando hist√≥rico...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-center">
                    <button onclick="loadMoreTrades()" id="btn-load-more" 
                            class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded">
                        Carregar Mais
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs Tab (MELHORADO) -->
        <div id="content-logs" class="hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">üìú Logs (Auto-refresh)</h2>
                    <div class="flex gap-2">
                        <button id="btn-pause-logs" onclick="toggleLogsPause()" 
                                class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded flex items-center gap-2">
                            ‚è∏Ô∏è Pausar
                        </button>
                        <button onclick="refreshLogs()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            üîÑ Atualizar
                        </button>
                        <button onclick="clearLogsDisplay()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                            üóëÔ∏è Limpar
                        </button>
                    </div>
                </div>
                <div class="bg-yellow-500/10 border border-yellow-500 rounded-lg p-3 mb-4 flex items-center gap-2">
                    <span class="text-yellow-500">‚ö°</span>
                    <span class="text-sm text-yellow-200" id="logs-status">
                        Auto-refresh ativo (a cada 3s)
                    </span>
                </div>
                <div id="logs-container" class="bg-gray-900 rounded p-4 h-96 overflow-y-auto font-mono text-sm">
                    <p class="text-gray-500">Carregando logs...</p>
                </div>
            </div>
        </div>

        <!-- CSV Analysis Tab -->
        <div id="content-csv-analysis" class="hidden">
            <!-- Upload Section -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">üì§ Upload CSV da Pacifica</h2>
                    <button onclick="refreshCSVList()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                        üîÑ Atualizar Lista
                    </button>
                </div>
                
                <!-- Upload Form -->
                <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center mb-6">
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('csv-file-input').click()" 
                            class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold mb-2">
                        üìÅ Selecionar CSV
                    </button>
                    <p class="text-gray-400 text-sm mt-2">Arraste um arquivo CSV aqui ou clique para selecionar</p>
                    <p class="text-gray-500 text-xs mt-1">Formato aceito: CSV exportado da Pacifica.fi (m√°x 16MB)</p>
                </div>
                
                <!-- Progress -->
                <div id="upload-progress" class="hidden">
                    <div class="bg-gray-700 rounded-full h-2 mb-2">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p id="upload-status" class="text-sm text-gray-400 text-center">Processando...</p>
                </div>
            </div>
            
            <!-- Available Files -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">üìÇ Arquivos Dispon√≠veis</h2>
                <div id="csv-files-list" class="space-y-2">
                    <p class="text-gray-500">Carregando...</p>
                </div>
            </div>
            
            <!-- Analysis Results -->
            <div id="csv-analysis-results" class="hidden">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">Total de Trades</p>
                        <p id="csv-total-trades" class="text-3xl font-bold">-</p>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">Win Rate</p>
                        <p id="csv-win-rate" class="text-3xl font-bold">-</p>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">PNL Total</p>
                        <p id="csv-total-pnl" class="text-3xl font-bold">-</p>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">Profit Factor</p>
                        <p id="csv-profit-factor" class="text-3xl font-bold">-</p>
                    </div>
                </div>
                
                <!-- Detailed Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">üìà Performance</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Trades Ganhos:</span>
                                <span id="csv-winning-trades" class="text-green-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Trades Perdidos:</span>
                                <span id="csv-losing-trades" class="text-red-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">M√©dia por Trade:</span>
                                <span id="csv-avg-trade" class="font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">M√©dia de Ganho:</span>
                                <span id="csv-avg-win" class="text-green-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">M√©dia de Perda:</span>
                                <span id="csv-avg-loss" class="text-red-400 font-bold">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">üí∞ Financeiro</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Volume Total:</span>
                                <span id="csv-total-volume" class="font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Fees Totais:</span>
                                <span id="csv-total-fees" class="text-red-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Lucro L√≠quido:</span>
                                <span id="csv-net-profit" class="font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Melhor Trade:</span>
                                <span id="csv-best-trade" class="text-green-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Pior Trade:</span>
                                <span id="csv-worst-trade" class="text-red-400 font-bold">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">üìä Distribui√ß√£o de Resultados</h3>
                        <canvas id="csv-winrate-chart"></canvas>
                    </div>
                    
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">üìà PNL Acumulado</h3>
                        <canvas id="csv-cumulative-pnl-chart"></canvas>
                    </div>
                </div>
                
                <!-- By Symbol -->
                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">üîç Performance por S√≠mbolo</h3>
                    <div id="csv-by-symbol" class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="border-b border-gray-700">
                                <tr class="text-left text-gray-400 text-sm">
                                    <th class="pb-3">S√≠mbolo</th>
                                    <th class="pb-3">Trades</th>
                                    <th class="pb-3">Win Rate</th>
                                    <th class="pb-3">PNL</th>
                                    <th class="pb-3">Fees</th>
                                    <th class="pb-3">Volume</th>
                                </tr>
                            </thead>
                            <tbody id="csv-symbol-tbody" class="text-sm">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Daily Stats -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">üìÖ Performance Di√°ria</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="border-b border-gray-700">
                                <tr class="text-left text-gray-400 text-sm">
                                    <th class="pb-3">Data</th>
                                    <th class="pb-3">Trades</th>
                                    <th class="pb-3">Win Rate</th>
                                    <th class="pb-3">PNL</th>
                                    <th class="pb-3">Volume</th>
                                </tr>
                            </thead>
                            <tbody id="csv-daily-tbody" class="text-sm">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Config Tab v1.1 - MELHORADO -->
        <div id="content-config" class="hidden">
            <!-- A√ß√µes R√°pidas -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">‚öôÔ∏è Configura√ß√µes R√°pidas</h2>
                    <button onclick="saveConfig()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded font-semibold flex items-center gap-2">
                        üíæ Salvar e Aplicar
                    </button>
                </div>
                
                <!-- Estrat√©gia -->
                <div class="bg-gray-700 rounded-lg p-4 mb-4">
                    <label class="block text-gray-300 mb-2 font-semibold">üéØ Estrat√©gia de Trading</label>
                    <select id="config-STRATEGY_TYPE" onchange="toggleStrategyOptions()"
                            class="w-full bg-gray-600 text-white px-4 py-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="market_making">üìä Market Making (Grid Din√¢mico)</option>
                        <option value="pure_grid">üìà Pure Grid (Grid Fixo)</option>
                        <option value="dynamic_grid">‚ö° Dynamic Grid (Grid Adaptativo)</option>
                        <option value="multi_asset">üåê Multi Asset (M√∫ltiplos Pares)</option>
                        <option value="multi_asset_enhanced">üöÄ Multi Asset Enhanced (Avan√ßado)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2">
                        üí° <strong>Market Making:</strong> Grid que se ajusta ao mercado |
                        <strong>Pure Grid:</strong> N√≠veis fixos |
                        <strong>Dynamic:</strong> Adaptativo |
                        <strong>Multi Asset:</strong> V√°rios ativos simult√¢neos
                    </p>
                </div>
                
                <!-- Op√ß√µes de Grid (vis√≠vel quando STRATEGY = grid) -->
                <div id="grid-options" class="space-y-4">
                    <h3 class="text-lg font-semibold text-blue-400 mb-3">ÔøΩ Configura√ß√µes do Grid</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Symbol -->
                        <div>
                            <label class="block text-gray-300 mb-2">üí± S√≠mbolo</label>
                            <input type="text" id="config-SYMBOL" placeholder="Ex: SOL"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">Par de trading (SOL, BTC, ETH...)</p>
                        </div>
                        
                        <!-- Grid Levels -->
                        <div>
                            <label class="block text-gray-300 mb-2">üî¢ N√≠veis do Grid</label>
                            <input type="number" id="config-GRID_LEVELS" min="3" max="20" placeholder="Ex: 8"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">N√∫mero de ordens (3-20)</p>
                        </div>
                        
                        <!-- Order Size -->
                        <div>
                            <label class="block text-gray-300 mb-2">üíµ Tamanho da Ordem (USD)</label>
                            <input type="number" id="config-ORDER_SIZE_USD" min="1" step="0.01" placeholder="Ex: 100"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">Valor em USD por ordem</p>
                        </div>
                        
                        <!-- Grid Spacing -->
                        <div>
                            <label class="block text-gray-300 mb-2">üìè Espa√ßamento do Grid (%)</label>
                            <input type="number" id="config-GRID_SPACING_PERCENT" min="0.1" max="5" step="0.1" placeholder="Ex: 0.2"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">Dist√¢ncia entre n√≠veis (0.1% - 5%)</p>
                        </div>
                        
                        <!-- Max Position -->
                        <div>
                            <label class="block text-gray-300 mb-2">üõ°Ô∏è Posi√ß√£o M√°xima (USD)</label>
                            <input type="number" id="config-MAX_POSITION_SIZE_USD" min="0" step="0.01" placeholder="Ex: 1000"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">Limite de exposi√ß√£o total</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Configura√ß√µes Avan√ßadas (Collapsible) -->
            <div class="bg-gray-800 rounded-lg p-6">
                <button onclick="toggleAdvancedConfig()" class="w-full flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">üîß Configura√ß√µes Avan√ßadas</h2>
                    <span id="advanced-toggle-icon" class="text-2xl">‚ñº</span>
                </button>
                <div id="advanced-config-container" class="space-y-4 hidden">
                    <p class="text-gray-500">Carregando configura√ß√µes avan√ßadas...</p>
                </div>
            </div>
        </div>

        <!-- Volume Tab -->
        <div id="content-volume" class="hidden">
            <!-- Cards de Volume por Per√≠odo -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-4 metric-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-gray-400 text-sm">√öltima Hora</p>
                    <span id="volume-1h-change" class="text-xs px-2 py-1 rounded bg-gray-700">-</span>
                </div>
                <p id="volume-1h" class="text-2xl font-bold text-blue-400">$0.00</p>
                <p class="text-gray-500 text-xs mt-1">
                    <span id="volume-1h-trades">0</span> trades
                </p>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4 metric-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-gray-400 text-sm">√öltimas 24h</p>
                    <span id="volume-24h-change" class="text-xs px-2 py-1 rounded bg-gray-700">-</span>
                </div>
                <p id="volume-24h" class="text-2xl font-bold text-green-400">$0.00</p>
                <p class="text-gray-500 text-xs mt-1">
                    <span id="volume-24h-trades">0</span> trades
                </p>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4 metric-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-gray-400 text-sm">√öltima Semana</p>
                    <span id="volume-7d-change" class="text-xs px-2 py-1 rounded bg-gray-700">-</span>
                </div>
                <p id="volume-7d" class="text-2xl font-bold text-purple-400">$0.00</p>
                <p class="text-gray-500 text-xs mt-1">
                    <span id="volume-7d-trades">0</span> trades
                </p>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4 metric-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-gray-400 text-sm">√öltimos 14 dias</p>
                    <span id="volume-14d-change" class="text-xs px-2 py-1 rounded bg-gray-700">-</span>
                </div>
                <p id="volume-14d" class="text-2xl font-bold text-yellow-400">$0.00</p>
                <p class="text-gray-500 text-xs mt-1">
                    <span id="volume-14d-trades">0</span> trades
                </p>
            </div>
        </div>
        
        <!-- M√©tricas Detalhadas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-4">üíµ Financeiro (24h)</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Volume Total:</span>
                        <span id="volume-total-24h" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Fees Pagos:</span>
                        <span id="volume-fees-24h" class="text-red-400 font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">PNL Total:</span>
                        <span id="volume-pnl-24h" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Avg por Trade:</span>
                        <span id="volume-avg-24h" class="font-bold">$0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-4">üìä Por S√≠mbolo (24h)</h3>
                <div id="volume-by-symbol" class="space-y-2 max-h-40 overflow-y-auto">
                    <p class="text-gray-500 text-sm">Carregando...</p>
                </div>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-4">üîÑ Por Dire√ß√£o (24h)</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-green-400">üü¢ Open Long:</span>
                        <span id="volume-open-long" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-red-400">üî¥ Open Short:</span>
                        <span id="volume-open-short" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-blue-400">üîµ Close Long:</span>
                        <span id="volume-close-long" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-yellow-400">üü° Close Short:</span>
                        <span id="volume-close-short" class="font-bold">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gr√°fico de Timeline -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold">üìà Evolu√ß√£o do Volume</h2>
                <div class="flex gap-2">
                    <button onclick="loadVolumeTimeline(6, 60)" 
                            class="px-3 py-1 bg-gray-700 rounded text-sm hover:bg-gray-600">
                        6h
                    </button>
                    <button onclick="loadVolumeTimeline(24, 60)" 
                            class="px-3 py-1 bg-blue-600 rounded text-sm hover:bg-blue-700">
                        24h
                    </button>
                    <button onclick="loadVolumeTimeline(168, 360)" 
                            class="px-3 py-1 bg-gray-700 rounded text-sm hover:bg-gray-600">
                        7d
                    </button>
                    <button onclick="loadVolumeTimeline(336, 720)" 
                            class="px-3 py-1 bg-gray-700 rounded text-sm hover:bg-gray-600">
                        14d
                    </button>
                </div>
            </div>
            <div style="height: 300px; position: relative;">
                <canvas id="volume-timeline-chart"></canvas>
            </div>
        </div>
        
        <!-- Compara√ß√£o com Per√≠odo Anterior -->
        <div class="bg-gray-800 rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-4">üìä Compara√ß√£o de Performance</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-sm text-gray-400 mb-3">Per√≠odo Atual (24h)</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Volume:</span>
                            <span id="comparison-current-volume" class="font-bold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Trades:</span>
                            <span id="comparison-current-trades" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>PNL:</span>
                            <span id="comparison-current-pnl" class="font-bold">$0.00</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-sm text-gray-400 mb-3">Per√≠odo Anterior (24h)</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Volume:</span>
                            <span id="comparison-previous-volume" class="font-bold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Trades:</span>
                            <span id="comparison-previous-trades" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>PNL:</span>
                            <span id="comparison-previous-pnl" class="font-bold">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Varia√ß√£o:</span>
                    <div class="flex items-center gap-2">
                        <span id="comparison-change-absolute" class="font-bold">$0.00</span>
                        <span id="comparison-change-percent" class="px-3 py-1 rounded font-bold">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>  <!-- Fecha o container principal mx-auto p-4 max-w-7xl -->

    <script>
        // Estado Global
        const API_BASE = window.location.origin;
        let socket = null;
        let currentTab = 'dashboard';
        let pnlChart = null;
        let volumeTimelineChart = null;
        let winrateChart = null;
        let pnlDistChart = null;
        let tradesLimit = 50;
        let logsPaused = false;
        let logsAutoScroll = true;
        
        console.log('üöÄ Dashboard v1.1 iniciado');

        // ========== WEBSOCKET ==========
        
        function initWebSocket() {
            console.log('üîå Iniciando conex√£o WebSocket com:', API_BASE);
            
            socket = io(API_BASE, {
                transports: ['polling'],
                upgrade: false,
                rememberUpgrade: false,
                timeout: 20000,
                forceNew: true
            });
            
            socket.on('connect', () => {
                console.log('‚úÖ WebSocket conectado - ID:', socket.id);
                updateWSStatus(true);
                showAlert('success', 'üîå Conectado ao servidor');
            });
            
            socket.on('disconnect', (reason) => {
                console.log('‚ùå WebSocket desconectado - Motivo:', reason);
                updateWSStatus(false);
                showAlert('error', 'üîå Desconectado do servidor');
            });
            
            socket.on('connect_error', (error) => {
                console.error('‚ùå Erro de conex√£o WebSocket:', error.message);
                updateWSStatus(false);
            });
            
            socket.on('bot_status_update', (data) => {
                updateBotStatus(data);
            });
            
            socket.on('metrics_update', (data) => {
                updateMetrics(data);
            });
            
            socket.on('pnl_history_update', (data) => {
                updatePNLChartData(data);
            });
            
            // NOVO: Posi√ß√µes e Ordens
            socket.on('positions_update', (data) => {
                updatePositions(data);
            });
            
            socket.on('orders_update', (data) => {
                updateOrders(data);
            });
            
            // NOVO: Logs auto-refresh
            socket.on('logs_update', (data) => {
                if (!logsPaused) {
                    updateLogsDisplay(data);
                }
            });
            
            socket.on('alert', (data) => {
                showAlert(data.type, data.message);
            });
        }
        
        function updateWSStatus(connected) {
            // Auto-refresh est√° sempre ativo - n√£o precisa atualizar status
        }

        // ========== ALERTS ==========
        
        function showAlert(type, message) {
            const container = document.getElementById('alerts-container');
            const id = 'alert-' + Date.now();
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            const alert = document.createElement('div');
            alert.id = id;
            alert.className = `alert-toast ${colors[type] || colors.info} text-white px-6 py-4 rounded-lg shadow-lg mb-2`;
            alert.innerHTML = `
                <div class="flex items-center justify-between gap-4">
                    <span>${message}</span>
                    <button onclick="closeAlert('${id}')" class="text-white hover:text-gray-200">‚úï</button>
                </div>
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                closeAlert(id);
            }, 5000);
        }
        
        function closeAlert(id) {
            const alert = document.getElementById(id);
            if (alert) {
                alert.classList.add('fade-out');
                setTimeout(() => alert.remove(), 300);
            }
        }

        // ========== TABS ==========
        
        function showTab(tab) {
            currentTab = tab;
            
            ['dashboard', 'volume', 'positions', 'charts', 'trades', 'logs', 'csv-analysis', 'config'].forEach(t => {
                const contentEl = document.getElementById(`content-${t}`);
                const tabEl = document.getElementById(`tab-${t}`);
                
                if (contentEl) {
                    contentEl.classList.add('hidden');
                }
                if (tabEl) {
                    tabEl.classList.remove('border-blue-500', 'text-blue-500');
                    tabEl.classList.add('text-gray-400');
                }
            });
            
            const activeContent = document.getElementById(`content-${tab}`);
            const activeTab = document.getElementById(`tab-${tab}`);
            
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
            if (activeTab) {
                activeTab.classList.add('border-blue-500', 'text-blue-500');
                activeTab.classList.remove('text-gray-400');
            }
            
            if (window.positionsInterval) {
                clearInterval(window.positionsInterval);
                window.positionsInterval = null;
            }
            if (tab === 'dashboard') {
                loadPositionsAndOrders();
            } else if (tab === 'volume') {
                loadVolumeStats();
                loadVolumeTimeline(24, 60);
                loadVolumeComparison('24h');
            } else if (tab === 'charts') {
                initCharts();
            } else if (tab === 'trades') {
                loadTrades();
            } else if (tab === 'logs') {
                refreshLogs();
            } else if (tab === 'csv-analysis') {
                refreshCSVList();
                if (!currentAnalysis) {
                    loadLastAnalysis();
                }
            } else if (tab === 'config') {
                loadConfig();
            } else if (tab === 'positions') {
                loadPositionsAndOrders();
                window.positionsInterval = setInterval(() => {
                    if (currentTab === 'positions') {
                        loadPositionsAndOrders();
                    }
                }, 30000); // 30 segundos
            }
        }

        // ========== HIST√ìRICO ==========
        async function loadHistoricalStats() {
    try {
        const response = await fetch(`${API_BASE}/api/historical-stats`);
        const data = await response.json();
        renderDailyPNLChart(data);
    } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
    }
}

function renderDailyPNLChart(data) {
    const ctx = document.getElementById('daily-pnl-chart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.days,
            datasets: [
                {
                    label: 'PNL Di√°rio (USD)',
                    data: data.pnl,
                    backgroundColor: data.pnl.map(v => v >= 0 ? 'rgba(34,197,94,0.8)' : 'rgba(239,68,68,0.8)')
                },
                {
                    label: 'Volume (USD)',
                    data: data.volume,
                    backgroundColor: 'rgba(59,130,246,0.3)',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: '#fff' } },
                title: { display: true, text: 'Estat√≠sticas Di√°rias - PNL e Volume', color: '#fff' }
            },
            scales: {
                x: { ticks: { color: '#9ca3af' } },
                y: { ticks: { color: '#9ca3af' }, beginAtZero: true },
                y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#9ca3af' } }
            }
        }
    });
}

        // ========== BOT CONTROLS ==========
        
        async function startBot() {
            try {
                showAlert('info', '‚è≥ Iniciando bot...');
                const response = await fetch(`${API_BASE}/api/bot/start`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', result.message);
                } else {
                    showAlert('error', result.message);
                }
            } catch (error) {
                console.error('‚ùå Erro ao iniciar bot:', error);
                showAlert('error', 'Erro ao iniciar bot: ' + error.message);
            }
        }
        
        async function stopBot(force) {
            try {
                showAlert('info', force ? '‚è≥ Parando bot (for√ßado)...' : '‚è≥ Parando bot...');
                const response = await fetch(`${API_BASE}/api/bot/stop`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({force})
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', result.message);
                } else {
                    showAlert('error', result.message);
                }
            } catch (error) {
                console.error('‚ùå Erro ao parar bot:', error);
                showAlert('error', 'Erro ao parar bot: ' + error.message);
            }
        }
        
        async function restartBot() {
            try {
                showAlert('info', '‚è≥ Reiniciando bot...');
                const response = await fetch(`${API_BASE}/api/bot/restart`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', result.message);
                } else {
                    showAlert('error', result.message);
                }
            } catch (error) {
                console.error('‚ùå Erro ao reiniciar bot:', error);
                showAlert('error', 'Erro ao reiniciar bot: ' + error.message);
            }
        }

        // ========== UPDATE FUNCTIONS ==========
        
        function updateBotStatus(data) {
            const statusText = document.getElementById('status-text');
            const btnStart = document.getElementById('btn-start');
            const btnStop = document.getElementById('btn-stop');
            const btnStopForce = document.getElementById('btn-stop-force');
            const btnRestart = document.getElementById('btn-restart');
            const systemInfo = document.getElementById('system-info');
            
            if (data.running) {
                statusText.innerHTML = 'üü¢ Rodando <span class="pulse-dot">‚óè</span>';
                btnStart.disabled = true;
                btnStart.classList.add('btn-disabled');
                btnStop.disabled = false;
                btnStop.classList.remove('btn-disabled');
                btnStopForce.disabled = false;
                btnStopForce.classList.remove('btn-disabled');
                btnRestart.disabled = false;
                btnRestart.classList.remove('btn-disabled');
                systemInfo.classList.remove('hidden');
                
                document.getElementById('pid-text').textContent = data.pid || '-';
                document.getElementById('cpu-text').textContent = (data.cpu_percent || 0).toFixed(1) + '%';
                document.getElementById('memory-text').textContent = (data.memory_mb || 0).toFixed(0) + ' MB';
                document.getElementById('uptime-text').textContent = formatUptime(data.uptime_seconds || 0);
            } else {
                statusText.textContent = 'üî¥ Parado';
                btnStart.disabled = false;
                btnStart.classList.remove('btn-disabled');
                btnStop.disabled = true;
                btnStop.classList.add('btn-disabled');
                btnStopForce.disabled = true;
                btnStopForce.classList.add('btn-disabled');
                btnRestart.disabled = true;
                btnRestart.classList.add('btn-disabled');
                systemInfo.classList.add('hidden');
            }
            
            document.getElementById('last-update').textContent = 
                '√öltima atualiza√ß√£o: ' + new Date().toLocaleTimeString('pt-BR');
        }
        
        function updateMetrics(data) {
            document.getElementById('pnl-text').textContent = `$${data.accumulated_pnl.toFixed(2)}`;
            document.getElementById('pnl-text').className = `text-2xl font-bold ${data.accumulated_pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            document.getElementById('cycles-text').textContent = data.cycles_closed || 0;
            document.getElementById('winrate-text').textContent = `${data.win_rate || 0}%`;
            document.getElementById('winrate-text').className = `text-2xl font-bold ${data.win_rate >= 50 ? 'text-green-400' : 'text-yellow-400'}`;
            
            document.getElementById('total-trades').textContent = data.total_trades || 0;
            document.getElementById('winning-trades').textContent = data.winning_trades || 0;
            document.getElementById('losing-trades').textContent = data.losing_trades || 0;
            
            document.getElementById('avg-win').textContent = `$${(data.avg_win || 0).toFixed(2)}`;
            document.getElementById('avg-loss').textContent = `$${(data.avg_loss || 0).toFixed(2)}`;
            document.getElementById('profit-factor').textContent = (data.profit_factor || 0).toFixed(2);
            document.getElementById('profit-factor').className = data.profit_factor >= 1 ? 'text-green-400' : 'text-red-400';
            
            document.getElementById('largest-win').textContent = `$${(data.largest_win || 0).toFixed(2)}`;
            document.getElementById('largest-loss').textContent = `$${(data.largest_loss || 0).toFixed(2)}`;
            document.getElementById('current-balance').textContent = `$${(data.current_balance || 0).toFixed(2)}`;
            
            if (currentTab === 'charts') {
                updateDistributionCharts(data);
            }
        }
        
        function formatUptime(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
            return `${Math.floor(seconds / 86400)}d ${Math.floor((seconds % 86400) / 3600)}h`;
        }

        // ========== POSI√á√ïES E ORDENS (NOVO) ==========
        
        async function loadPositionsAndOrders() {
            try {
                console.log('üîÑ Carregando posi√ß√µes, ordens e estado da conta...');
                const [posRes, ordRes, accRes] = await Promise.all([
                    fetch(`${API_BASE}/api/positions`),
                    fetch(`${API_BASE}/api/orders`),
                    fetch(`${API_BASE}/api/account-state`)
                ]);
                
                const positions = await posRes.json();
                const orders = await ordRes.json();
                const accountState = await accRes.json();
                
                console.log('üìä Posi√ß√µes recebidas:', positions.length, positions);
                console.log('üìã Ordens recebidas:', orders.length, orders);
                console.log('üí∞ Estado da conta:', accountState);
                
                updatePositions(positions);
                updateOrders(orders);
                updateAccountState(accountState);
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
            }
        }
        
        function updatePositions(positions) {
            console.log('üîÑ updatePositions chamada com:', positions.length, 'posi√ß√µes');
            const container = document.getElementById('positions-container');
            const countEl = document.getElementById('positions-count');
            if (countEl) countEl.textContent = positions.length;

            if (positions.length === 0) {
                if (container) container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma posi√ß√£o ativa</p>';
                const totalPnlEl = document.getElementById('positions-total-pnl');
                if (totalPnlEl) totalPnlEl.textContent = '$0.00';
                const exposureEl = document.getElementById('positions-exposure');
                if (exposureEl) exposureEl.textContent = '$0.00';
                return;
            }
            
            let unrealizedPnl = 0;
            let realizedPnl = 0;
            let totalExposure = 0;

            if (container) container.innerHTML = positions.map(pos => {
                // Converter strings para n√∫meros
                const pnl = parseFloat(pos.pnl_usd || pos.unrealized_pnl || 0);
                const size = parseFloat(pos.size || pos.amount || 0);
                const entryPrice = parseFloat(pos.entry_price || pos.avg_price || 0);
                const currentPrice = parseFloat(pos.current_price || entryPrice || 0);
                const pnlPercent = parseFloat(pos.pnl_percent || 0);

                // PNL n√£o realizado: posi√ß√µes abertas
                unrealizedPnl += pnl;
                // PNL realizado: hist√≥rico fechado (se vier no objeto)
                if (pos.realized_pnl) {
                    realizedPnl += parseFloat(pos.realized_pnl);
                }

                totalExposure += entryPrice * size;

                const pnlClass = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const sideClass = (pos.side || '').toLowerCase().includes('long') ? 'position-long' : 'position-short';
                const sideLabel = (pos.side || '').toLowerCase().includes('long') ? 'üü¢ LONG' : 'üî¥ SHORT';

                return `
                    <div class="bg-gray-700 rounded-lg p-4 ${sideClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-bold text-lg">${pos.symbol || '-'}</span>
                                <span class="ml-2 text-sm">${sideLabel}</span>
                            </div>
                            <span class="${pnlClass} font-bold">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-400">Tamanho:</span>
                                <span class="ml-1">${size.toFixed(4)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Entrada:</span>
                                <span class="ml-1">$${entryPrice.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Atual:</span>
                                <span class="ml-1">$${currentPrice.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Ativo h√°:</span>
                                <span class="ml-1">${pos.duration_str || '-'}</span>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-600">
                            <span class="text-gray-400 text-xs">PNL: </span>
                            <span class="${pnlClass} text-sm font-semibold">
                                ${pnlPercent.toFixed(2)}%
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            const unrealizedEl = document.getElementById('unrealized-pnl');
            if (unrealizedEl) {
                unrealizedEl.textContent = `$${unrealizedPnl.toFixed(2)}`;
                unrealizedEl.className = `text-2xl font-bold ${unrealizedPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            }
            const realizedEl = document.getElementById('realized-pnl');
            if (realizedEl) {
                realizedEl.textContent = `$${realizedPnl.toFixed(2)}`;
                realizedEl.className = `text-2xl font-bold ${realizedPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            }
            const exposureEl = document.getElementById('positions-exposure');
            if (exposureEl) exposureEl.textContent = `$${totalExposure.toFixed(2)}`;
        }
        
        function updateOrders(orders) {
            console.log('üîÑ updateOrders chamada com:', orders.length, 'ordens');
            const container = document.getElementById('orders-container');
            const countEl = document.getElementById('orders-count');
            if (countEl) countEl.textContent = orders.length;

            if (orders.length === 0) {
                if (container) container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma ordem aberta</p>';
                const pendingValueEl = document.getElementById('orders-pending-value');
                if (pendingValueEl) pendingValueEl.textContent = '$0.00';
                return;
            }
            
            let totalValue = 0;
            let buyOrders = 0;
            let sellOrders = 0;
            
            if (container) container.innerHTML = orders.map(order => {
                // Converter strings para n√∫meros
                const price = parseFloat(order.price || 0);
                const size = parseFloat(order.size || order.initial_amount || 0);
                const value = price * size;
                totalValue += value;
                
                const side = (order.side || '').toLowerCase();
                if (side.includes('buy') || side === 'bid') {
                    buyOrders++;
                } else {
                    sellOrders++;
                }
                
                const sideClass = side.includes('buy') || side === 'bid' ? 'order-buy' : 'order-sell';
                const sideLabel = side.includes('buy') || side === 'bid' ? 'üîµ BUY' : 'üü† SELL';
                
                return `
                    <div class="bg-gray-700 rounded-lg p-4 ${sideClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-bold">${order.symbol || '-'}</span>
                                <span class="ml-2 text-sm">${sideLabel}</span>
                            </div>
                            <span class="text-gray-400 text-sm">${order.age_str || '-'}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-400">Pre√ßo:</span>
                                <span class="ml-1">$${price.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Tamanho:</span>
                                <span class="ml-1">${size.toFixed(4)}</span>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-400">Valor:</span>
                                <span class="ml-1 font-semibold">$${value.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const pendingValueEl = document.getElementById('orders-pending-value');
            if (pendingValueEl) pendingValueEl.textContent = `$${totalValue.toFixed(2)}`;
            
            // Calcular % do grid preenchido (buy + sell orders) - DESABILITADO: elemento n√£o existe no HTML
            // const totalOrders = buyOrders + sellOrders;
            // const gridFillPercent = totalOrders > 0 ? ((buyOrders + sellOrders) / (totalOrders * 2)) * 100 : 0;
            // const gridFillEl = document.getElementById('grid-fill-percent');
            // if (gridFillEl) gridFillEl.textContent = `${gridFillPercent.toFixed(0)}%`;
        }
        
        function updateAccountState(state) {
            console.log('üí∞ Atualizando estado da conta:', state);
            
            // Saldo
            const balanceEl = document.getElementById('account-balance');
            if (balanceEl) {
                balanceEl.textContent = `$${(state.balance || 0).toFixed(2)}`;
            }
            
            // Margem Usada
            const marginUsedEl = document.getElementById('margin-used');
            if (marginUsedEl) {
                marginUsedEl.textContent = `$${(state.margin_used || 0).toFixed(2)}`;
            }
            
            // Margem Dispon√≠vel
            const marginAvailableEl = document.getElementById('margin-available');
            if (marginAvailableEl) {
                marginAvailableEl.textContent = `$${(state.margin_available || 0).toFixed(2)}`;
            }
            
            // Margem Livre (%)
            const marginFreePercent = state.margin_free_percent || 0;
            const marginFreePercentEl = document.getElementById('margin-free-percent');
            if (marginFreePercentEl) {
                marginFreePercentEl.textContent = `${marginFreePercent.toFixed(1)}%`;
                
                // Alterar cor baseado no percentual
                if (marginFreePercent < 20) {
                    marginFreePercentEl.className = 'text-2xl font-bold text-red-400';
                } else if (marginFreePercent < 50) {
                    marginFreePercentEl.className = 'text-2xl font-bold text-orange-400';
                } else {
                    marginFreePercentEl.className = 'text-2xl font-bold text-green-400';
                }
            }
            
            // Barra de progresso
            const marginFreeBarEl = document.getElementById('margin-free-bar');
            if (marginFreeBarEl) {
                marginFreeBarEl.style.width = `${marginFreePercent}%`;
                
                // Alterar cor da barra baseado no percentual
                if (marginFreePercent < 20) {
                    marginFreeBarEl.className = 'bg-red-500 h-2 rounded-full transition-all';
                } else if (marginFreePercent < 50) {
                    marginFreeBarEl.className = 'bg-orange-500 h-2 rounded-full transition-all';
                } else {
                    marginFreeBarEl.className = 'bg-green-500 h-2 rounded-full transition-all';
                }
            }
            
            // Texto de status
            const marginStatusEl = document.getElementById('margin-status-text');
            if (marginStatusEl) {
                if (marginFreePercent < 20) {
                    marginStatusEl.textContent = '‚ö†Ô∏è Margem Cr√≠tica - Risco Alto';
                    marginStatusEl.className = 'text-xs text-red-400 text-center font-semibold';
                } else if (marginFreePercent < 50) {
                    marginStatusEl.textContent = '‚ö° Aten√ß√£o - Margem M√©dia';
                    marginStatusEl.className = 'text-xs text-orange-400 text-center';
                } else {
                    marginStatusEl.textContent = '‚úÖ Margem Saud√°vel';
                    marginStatusEl.className = 'text-xs text-green-400 text-center';
                }
            }
            
            // √öltima atualiza√ß√£o
            const balanceUpdatedEl = document.getElementById('balance-updated');
            if (balanceUpdatedEl && state.last_update) {
                const updateTime = new Date(state.last_update);
                const now = new Date();
                const diffSeconds = Math.floor((now - updateTime) / 1000);
                
                let timeText;
                if (diffSeconds < 60) {
                    timeText = 'agora mesmo';
                } else if (diffSeconds < 3600) {
                    timeText = `h√° ${Math.floor(diffSeconds / 60)}min`;
                } else {
                    timeText = updateTime.toLocaleTimeString('pt-BR');
                }
                balanceUpdatedEl.textContent = timeText;
            }
        }

        // ========== LOGS COM AUTO-REFRESH (MELHORADO) ==========
        
        function toggleLogsPause() {
            logsPaused = !logsPaused;
            const btn = document.getElementById('btn-pause-logs');
            const status = document.getElementById('logs-status');
            
            if (logsPaused) {
                btn.innerHTML = '‚ñ∂Ô∏è Retomar';
                btn.className = 'bg-green-600 hover:bg-green-700 px-4 py-2 rounded flex items-center gap-2';
                status.textContent = 'Auto-refresh PAUSADO';
            } else {
                btn.innerHTML = '‚è∏Ô∏è Pausar';
                btn.className = 'bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded flex items-center gap-2';
                status.textContent = 'Auto-refresh ativo (a cada 3s)';
                refreshLogs(); // Atualizar imediatamente ao retomar
            }
        }
        
        async function refreshLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/logs?lines=200`);
                const data = await response.json();
                updateLogsDisplay(data);
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
            }
        }
        
        function updateLogsDisplay(data) {
            const container = document.getElementById('logs-container');
            
            // Verificar se usu√°rio est√° no final (para auto-scroll inteligente)
            const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
            
            container.innerHTML = data.logs.map(line => {
                let className = 'log-line';
                if (line.includes('ERROR') || line.includes('‚ùå')) className += ' log-error';
                else if (line.includes('WARNING') || line.includes('‚ö†Ô∏è')) className += ' log-warning';
                else if (line.includes('INFO') || line.includes('‚úÖ')) className += ' log-info';
                else if (line.includes('DEBUG')) className += ' log-debug';
                
                return `<div class="${className}">${line}</div>`;
            }).join('');
            
            // Auto-scroll INTELIGENTE: s√≥ faz scroll se usu√°rio estava no final
            if (wasAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function clearLogsDisplay() {
            document.getElementById('logs-container').innerHTML = '<p class="text-gray-500">Logs limpos. Clique em Atualizar para recarregar.</p>';
        }

        // ========== CHARTS ==========
        
        function initCharts() {
            if (!pnlChart) {
                const ctx = document.getElementById('pnl-chart').getContext('2d');
                pnlChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'PNL Acumulado',
                            data: [],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
            
            if (!winrateChart) {
                const ctx2 = document.getElementById('winrate-chart').getContext('2d');
                winrateChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ganhos', 'Perdas'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } },
                            title: {
                                display: true,
                                text: 'Win Rate',
                                color: '#fff'
                            }
                        }
                    }
                });
            }
            
            if (!pnlDistChart) {
                const ctx3 = document.getElementById('pnl-distribution-chart').getContext('2d');
                pnlDistChart = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['< -$10', '-$10 a -$5', '-$5 a $0', '$0 a $5', '$5 a $10', '> $10'],
                        datasets: [{
                            label: 'N√∫mero de Trades',
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(251, 146, 60, 0.8)',
                                'rgba(250, 204, 21, 0.8)',
                                'rgba(132, 204, 22, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(16, 185, 129, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } },
                            title: {
                                display: true,
                                text: 'Distribui√ß√£o de PNL',
                                color: '#fff'
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }
        
        function updatePNLChartData(data) {
            if (!pnlChart) return;
            
            const labels = data.map(d => {
                const date = new Date(d.timestamp);
                return date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            });
            
            const values = data.map(d => d.accumulated);
            
            pnlChart.data.labels = labels;
            pnlChart.data.datasets[0].data = values;
            pnlChart.update();
        }
        
        function updateDistributionCharts(metrics) {
            if (winrateChart) {
                winrateChart.data.datasets[0].data = [
                    metrics.winning_trades || 0,
                    metrics.losing_trades || 0
                ];
                winrateChart.update();
            }
        }
        
        async function updatePNLChart(hours) {
            try {
                const response = await fetch(`${API_BASE}/api/pnl-history?hours=${hours}`);
                const data = await response.json();
                updatePNLChartData(data);
            } catch (error) {
                console.error('Erro ao atualizar gr√°fico PNL:', error);
            }
        }
        
        async function loadPNLHistory(hours) {
            try {
                const response = await fetch(`${API_BASE}/api/pnl-history?hours=${hours}`);
                const data = await response.json();
                updatePNLChartData(data);
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico PNL:', error);
            }
        }

        // ========== TRADES ==========
        
        async function loadTrades() {
            try {
                const response = await fetch(`${API_BASE}/api/trades?limit=${tradesLimit}`);
                const trades = await response.json();
                
                const tbody = document.getElementById('trades-table-body');
                
                if (trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Nenhum trade registrado</td></tr>';
                    return;
                }
                
                tbody.innerHTML = trades.map(trade => {
                    const timestamp = new Date(trade.timestamp).toLocaleString('pt-BR');
                    const pnl = trade.pnl_usd || 0;
                    const pnlClass = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                    const rowClass = pnl >= 0 ? 'trade-row-profit' : 'trade-row-loss';
                    
                    return `
                        <tr class="${rowClass}">
                            <td class="px-4 py-3">${timestamp}</td>
                            <td class="px-4 py-3">${trade.symbol || '-'}</td>
                            <td class="px-4 py-3 text-right ${pnlClass} font-semibold">$${pnl.toFixed(2)}</td>
                            <td class="px-4 py-3 text-right ${pnlClass}">${(trade.pnl_percent || 0).toFixed(2)}%</td>
                            <td class="px-4 py-3 text-right">${(trade.duration_minutes || 0).toFixed(1)}min</td>
                            <td class="px-4 py-3">${trade.reason || '-'}</td>
                            <td class="px-4 py-3 text-right">${(trade.accumulated_pnl || 0).toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar trades:', error);
                showAlert('error', 'Erro ao carregar hist√≥rico de trades');
            }
        }
        
        function refreshTrades() {
            tradesLimit = 50;
            loadTrades();
        }
        
        function loadMoreTrades() {
            tradesLimit += 50;
            loadTrades();
        }

        // ========== CONFIG v1.1 ==========
        
        function toggleStrategyOptions() {
            const strategy = document.getElementById('config-STRATEGY_TYPE').value;
            const gridOptions = document.getElementById('grid-options');
            
            // Mostrar op√ß√µes de grid para todas as estrat√©gias baseadas em grid
            const gridBasedStrategies = ['market_making', 'pure_grid', 'dynamic_grid'];
            
            if (gridBasedStrategies.includes(strategy)) {
                gridOptions.classList.remove('hidden');
            } else {
                // Multi Asset strategies n√£o usam as mesmas configs de grid
                gridOptions.classList.add('hidden');
            }
        }
        
        function toggleAdvancedConfig() {
            const container = document.getElementById('advanced-config-container');
            const icon = document.getElementById('advanced-toggle-icon');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                icon.textContent = '‚ñ≤';
            } else {
                container.classList.add('hidden');
                icon.textContent = '‚ñº';
            }
        }
        
        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/config`);
                const config = await response.json();
                
                if (Object.keys(config).length === 0) {
                    showAlert('error', '‚ö†Ô∏è Arquivo .env n√£o encontrado');
                    return;
                }
                
                // Campos de configura√ß√£o r√°pida
                const quickFields = ['STRATEGY_TYPE', 'SYMBOL', 'GRID_LEVELS', 'ORDER_SIZE_USD', 'GRID_SPACING_PERCENT', 'MAX_POSITION_SIZE_USD'];
                
                quickFields.forEach(key => {
                    const input = document.getElementById(`config-${key}`);
                    if (input && config[key] !== undefined) {
                        input.value = config[key];
                    }
                });
                
                // Mostrar/ocultar op√ß√µes de grid
                toggleStrategyOptions();
                
                // Configura√ß√µes avan√ßadas
                const advancedContainer = document.getElementById('advanced-config-container');
                const advancedFields = Object.entries(config).filter(([key]) => !quickFields.includes(key));
                
                if (advancedFields.length > 0) {
                    advancedContainer.innerHTML = advancedFields.map(([key, value]) => {
                        const isSecret = key.includes('PASSWORD') || key.includes('KEY') || key.includes('SECRET') || key === 'PRIVATE_KEY' || key === 'WALLET_ADDRESS';
                        return `
                            <div class="grid grid-cols-3 gap-4 items-center">
                                <label class="text-gray-400">${key}</label>
                                <input 
                                    type="${isSecret ? 'password' : 'text'}"
                                    id="config-advanced-${key}"
                                    value="${value}"
                                    class="col-span-2 bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                        `;
                    }).join('');
                } else {
                    advancedContainer.innerHTML = '<p class="text-gray-500">Nenhuma configura√ß√£o avan√ßada dispon√≠vel</p>';
                }
                
                console.log('‚úÖ Configura√ß√µes carregadas');
            } catch (error) {
                console.error('Erro ao carregar config:', error);
                showAlert('error', 'Erro ao carregar configura√ß√µes');
            }
        }
        
        async function saveConfig() {
            try {
                // Confirmar a√ß√£o
                const botRunning = await isBotCurrentlyRunning();
                
                let confirmMessage = 'üíæ Salvar configura√ß√µes?';
                if (botRunning) {
                    confirmMessage = 'üíæ Salvar e reiniciar o bot?\n\n‚ö†Ô∏è O bot est√° rodando e ser√° reiniciado automaticamente para aplicar as novas configura√ß√µes.';
                }
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                showAlert('info', '‚è≥ Salvando configura√ß√µes...');
                
                // Coletar todas as configura√ß√µes
                const response = await fetch(`${API_BASE}/api/config`);
                const config = await response.json();
                
                const updates = {};
                
                // Campos r√°pidos
                const quickFields = ['STRATEGY_TYPE', 'SYMBOL', 'GRID_LEVELS', 'ORDER_SIZE_USD', 'GRID_SPACING_PERCENT', 'MAX_POSITION_SIZE_USD'];
                quickFields.forEach(key => {
                    const input = document.getElementById(`config-${key}`);
                    if (input && input.value) {
                        updates[key] = input.value;
                    }
                });
                
                // Campos avan√ßados
                for (const key of Object.keys(config)) {
                    const advInput = document.getElementById(`config-advanced-${key}`);
                    if (advInput) {
                        updates[key] = advInput.value;
                    }
                }
                
                // Salvar
                const saveResponse = await fetch(`${API_BASE}/api/config/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updates)
                });
                
                const result = await saveResponse.json();
                
                if (result.status !== 'success') {
                    showAlert('error', result.message);
                    return;
                }
                
                showAlert('success', '‚úÖ Configura√ß√µes salvas!');
                
                // Se bot est√° rodando, reiniciar automaticamente
                if (botRunning) {
                    showAlert('info', 'üîÑ Reiniciando bot...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const restartResult = await fetch(`${API_BASE}/api/bot/restart`, {
                        method: 'POST'
                    });
                    
                    const restartData = await restartResult.json();
                    
                    if (restartData.status === 'success') {
                        showAlert('success', 'üéâ Bot reiniciado! Novas configura√ß√µes aplicadas.');
                    } else {
                        showAlert('error', '‚ùå Erro ao reiniciar: ' + restartData.message);
                    }
                } else {
                    showAlert('info', '‚ÑπÔ∏è Inicie o bot para aplicar as configura√ß√µes.');
                }
                
            } catch (error) {
                console.error('Erro ao salvar config:', error);
                showAlert('error', 'Erro ao salvar configura√ß√µes: ' + error.message);
            }
        }
        
        async function isBotCurrentlyRunning() {
            try {
                const response = await fetch(`${API_BASE}/api/bot/status`);
                const status = await response.json();
                return status.running === true;
            } catch (error) {
                return false;
            }
        }

        // ========== EXPORT ==========
        
        function exportCSV() {
            window.open(`${API_BASE}/api/export/csv`, '_blank');
            showAlert('success', 'üì• Exportando CSV...');
        }

        // ========== VOLUME TRACKING ==========

        async function loadVolumeStats() {
            try {
                const response = await fetch(`${API_BASE}/api/volume/stats?periods=1h,24h,7d,14d`);
                const stats = await response.json();
                
                updateVolumeCards(stats);
                
                // Carregar detalhes de 24h
                if (stats['24h']) {
                    updateVolumeDetails(stats['24h']);
                }
                
            } catch (error) {
                console.error('Erro ao carregar volume:', error);
            }
        }

        function updateVolumeCards(stats) {
            const periods = ['1h', '24h', '7d', '14d'];
            
            periods.forEach(period => {
                const data = stats[period];
                if (!data) return;
                
                // Volume total
                const volumeEl = document.getElementById(`volume-${period}`);
                if (volumeEl) {
                    volumeEl.textContent = `$${formatNumber(data.total_volume)}`;
                }
                
                // N√∫mero de trades
                const tradesEl = document.getElementById(`volume-${period}-trades`);
                if (tradesEl) {
                    tradesEl.textContent = data.total_trades;
                }
                
                // Badge de varia√ß√£o (ser√° preenchido pela compara√ß√£o)
                const changeEl = document.getElementById(`volume-${period}-change`);
                if (changeEl) {
                    changeEl.textContent = '...';
                    changeEl.className = 'text-xs px-2 py-1 rounded bg-gray-700';
                }
            });
        }

        function updateVolumeDetails(data) {
            // Financeiro
            document.getElementById('volume-total-24h').textContent = `$${formatNumber(data.total_volume)}`;
            document.getElementById('volume-fees-24h').textContent = `$${formatNumber(data.total_fees)}`;
            
            const pnlEl = document.getElementById('volume-pnl-24h');
            pnlEl.textContent = `$${formatNumber(data.total_pnl)}`;
            pnlEl.className = data.total_pnl >= 0 ? 'font-bold text-green-400' : 'font-bold text-red-400';
            
            const avgVolume = data.total_trades > 0 ? data.total_volume / data.total_trades : 0;
            document.getElementById('volume-avg-24h').textContent = `$${formatNumber(avgVolume)}`;
            
            // Por s√≠mbolo
            const symbolContainer = document.getElementById('volume-by-symbol');
            if (data.by_symbol && Object.keys(data.by_symbol).length > 0) {
                symbolContainer.innerHTML = Object.entries(data.by_symbol)
                    .sort(([,a], [,b]) => b.volume - a.volume)
                    .map(([symbol, info]) => `
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-300">${symbol}:</span>
                            <div class="flex items-center gap-2">
                                <span class="font-bold">$${formatNumber(info.volume)}</span>
                                <span class="text-xs text-gray-500">(${info.trades})</span>
                            </div>
                        </div>
                    `).join('');
            } else {
                symbolContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhum trade encontrado</p>';
            }
            
            // Por dire√ß√£o
            if (data.by_side) {
                document.getElementById('volume-open-long').textContent = `$${formatNumber(data.by_side.open_long || 0)}`;
                document.getElementById('volume-open-short').textContent = `$${formatNumber(data.by_side.open_short || 0)}`;
                document.getElementById('volume-close-long').textContent = `$${formatNumber(data.by_side.close_long || 0)}`;
                document.getElementById('volume-close-short').textContent = `$${formatNumber(data.by_side.close_short || 0)}`;
            }
        }

        async function loadVolumeTimeline(hours = 24, interval = 60) {
            try {
                const response = await fetch(`${API_BASE}/api/volume/timeline?hours=${hours}&interval=${interval}`);
                const timeline = await response.json();
                
                if (!Array.isArray(timeline) || timeline.length === 0) {
                    console.warn('Timeline de volume vazia');
                    return;
                }
                
                updateVolumeTimelineChart(timeline);
                
            } catch (error) {
                console.error('Erro ao carregar timeline:', error);
            }
        }

        function updateVolumeTimelineChart(timeline) {
            const ctx = document.getElementById('volume-timeline-chart');
            if (!ctx) return;
            
            if (volumeTimelineChart) {
                volumeTimelineChart.destroy();
            }
            
            const labels = timeline.map(point => {
                const date = new Date(point.timestamp);
                return date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            });
            
            const volumes = timeline.map(point => point.volume);
            
            volumeTimelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume (USD)',
                        data: volumes,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = timeline[context.dataIndex];
                                    return [
                                        `Volume: $${formatNumber(point.volume)}`,
                                        `Trades: ${point.trades}`,
                                        `PNL: $${formatNumber(point.pnl)}`
                                    ];
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { 
                                color: '#9ca3af',
                                maxTicksLimit: 12
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#9ca3af',
                                callback: value => `$${formatNumber(value)}`
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        async function loadVolumeComparison(period = '24h') {
            try {
                const response = await fetch(`${API_BASE}/api/volume/comparison?period=${period}`);
                const comparison = await response.json();
                
                updateVolumeComparison(comparison);
                
            } catch (error) {
                console.error('Erro ao carregar compara√ß√£o:', error);
            }
        }

        function updateVolumeComparison(comparison) {
            // Per√≠odo atual
            document.getElementById('comparison-current-volume').textContent = 
                `$${formatNumber(comparison.current.total_volume)}`;
            document.getElementById('comparison-current-trades').textContent = 
                comparison.current.total_trades;
            
            const currentPnlEl = document.getElementById('comparison-current-pnl');
            currentPnlEl.textContent = `$${formatNumber(comparison.current.total_pnl)}`;
            currentPnlEl.className = comparison.current.total_pnl >= 0 ? 
                'font-bold text-green-400' : 'font-bold text-red-400';
            
            // Per√≠odo anterior
            document.getElementById('comparison-previous-volume').textContent = 
                `$${formatNumber(comparison.previous.total_volume)}`;
            document.getElementById('comparison-previous-trades').textContent = 
                comparison.previous.total_trades;
            
            const prevPnlEl = document.getElementById('comparison-previous-pnl');
            prevPnlEl.textContent = `$${formatNumber(comparison.previous.total_pnl)}`;
            prevPnlEl.className = comparison.previous.total_pnl >= 0 ? 
                'font-bold text-green-400' : 'font-bold text-red-400';
            
            // Varia√ß√£o
            document.getElementById('comparison-change-absolute').textContent = 
                `${comparison.change_absolute >= 0 ? '+' : ''}$${formatNumber(comparison.change_absolute)}`;
            
            const changePercentEl = document.getElementById('comparison-change-percent');
            changePercentEl.textContent = `${comparison.change_percent >= 0 ? '+' : ''}${comparison.change_percent.toFixed(1)}%`;
            
            if (comparison.change_percent >= 0) {
                changePercentEl.className = 'px-3 py-1 rounded font-bold bg-green-600 text-white';
            } else {
                changePercentEl.className = 'px-3 py-1 rounded font-bold bg-red-600 text-white';
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num.toFixed(2);
        }

        // ========== INIT ==========
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ DOM carregado');
            initWebSocket();
            showTab('dashboard');
            
            // Carregar dados iniciais
            loadPositionsAndOrders();
            
            
            // Polling peri√≥dico para dados (fallback se WebSocket falhar)
            setInterval(() => {
                loadPositionsAndOrders();
            }, 30000); // A cada 30 segundos
        });
        
        // ========== CSV ANALYSIS VARIABLES ==========
        let csvWinrateChart = null;
        let csvCumulativePNLChart = null;
        let currentAnalysis = null;
        
        // ========== CSV UPLOAD FUNCTIONS ==========
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showAlert('error', '‚ùå Arquivo deve ser CSV');
                return;
            }
            
            await uploadAndAnalyzeCSV(file);
        }
        
        async function uploadAndAnalyzeCSV(file) {
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const statusText = document.getElementById('upload-status');
            
            try {
                progressDiv.classList.remove('hidden');
                progressBar.style.width = '10%';
                statusText.textContent = 'Enviando arquivo...';
                
                const formData = new FormData();
                formData.append('file', file);
                
                progressBar.style.width = '40%';
                
                const response = await fetch(`${API_BASE}/api/csv/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                progressBar.style.width = '70%';
                statusText.textContent = 'Processando CSV...';
                
                const result = await response.json();
                
                progressBar.style.width = '100%';
                
                if (result.status === 'success') {
                    showAlert('success', `‚úÖ ${result.message}`);
                    
                    // Mostrar resultados
                    displayAnalysis(result.stats);
                    
                    // Atualizar lista de arquivos
                    await refreshCSVList();
                    
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        progressBar.style.width = '0%';
                    }, 2000);
                } else {
                    showAlert('error', `‚ùå ${result.message}`);
                    progressDiv.classList.add('hidden');
                }
                
                // Limpar input
                document.getElementById('csv-file-input').value = '';
                
            } catch (error) {
                console.error('Erro no upload:', error);
                showAlert('error', '‚ùå Erro ao processar arquivo');
                progressDiv.classList.add('hidden');
            }
        }
        
        // ========== CSV FILE LIST ==========
        
        async function refreshCSVList() {
            try {
                const response = await fetch(`${API_BASE}/api/csv/list`);
                const result = await response.json();
                
                const container = document.getElementById('csv-files-list');
                
                if (result.status === 'success' && result.files.length > 0) {
                    container.innerHTML = result.files.map(file => {
                        const date = new Date(file.modified).toLocaleString('pt-BR');
                        const size = (file.size / 1024).toFixed(1);
                        
                        return `
                            <div class="flex items-center justify-between bg-gray-700 rounded p-3 hover:bg-gray-600">
                                <div class="flex-1">
                                    <p class="font-semibold">${file.filename}</p>
                                    <p class="text-sm text-gray-400">${size} KB - ${date}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="analyzeCSVFile('${file.filename}')" 
                                            class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                                        üìä Analisar
                                    </button>
                                    <button onclick="deleteCSVFile('${file.filename}')" 
                                            class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-500">Nenhum arquivo CSV encontrado. Fa√ßa upload de um CSV da Pacifica.</p>';
                }
            } catch (error) {
                console.error('Erro ao listar CSVs:', error);
            }
        }
        
        async function analyzeCSVFile(filename) {
            try {
                showAlert('info', `üìä Analisando ${filename}...`);
                
                const response = await fetch(`${API_BASE}/api/csv/analyze/${encodeURIComponent(filename)}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayAnalysis(result.data);
                    showAlert('success', '‚úÖ An√°lise conclu√≠da!');
                } else {
                    showAlert('error', `‚ùå ${result.message}`);
                }
            } catch (error) {
                console.error('Erro ao analisar:', error);
                showAlert('error', '‚ùå Erro ao analisar arquivo');
            }
        }
        
        async function deleteCSVFile(filename) {
            if (!confirm(`Tem certeza que deseja deletar ${filename}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/csv/delete/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', '‚úÖ Arquivo deletado');
                    await refreshCSVList();
                } else {
                    showAlert('error', `‚ùå ${result.message}`);
                }
            } catch (error) {
                console.error('Erro ao deletar:', error);
                showAlert('error', '‚ùå Erro ao deletar arquivo');
            }
        }
        
        // ========== DISPLAY ANALYSIS ==========
        
        function displayAnalysis(stats) {
            currentAnalysis = stats;
            const summary = stats.summary;
            
            // Show results section
            document.getElementById('csv-analysis-results').classList.remove('hidden');
            
            // Update summary cards
            document.getElementById('csv-total-trades').textContent = summary.total_trades;
            document.getElementById('csv-win-rate').textContent = `${summary.win_rate}%`;
            document.getElementById('csv-total-pnl').textContent = `$${summary.total_pnl.toFixed(2)}`;
            document.getElementById('csv-total-pnl').className = `text-3xl font-bold ${summary.total_pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('csv-profit-factor').textContent = summary.profit_factor.toFixed(2);
            
            // Update detailed stats
            document.getElementById('csv-winning-trades').textContent = summary.winning_trades;
            document.getElementById('csv-losing-trades').textContent = summary.losing_trades;
            document.getElementById('csv-avg-trade').textContent = `$${summary.avg_trade.toFixed(2)}`;
            document.getElementById('csv-avg-trade').className = `font-bold ${summary.avg_trade >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('csv-avg-win').textContent = `$${summary.avg_win.toFixed(2)}`;
            document.getElementById('csv-avg-loss').textContent = `$${summary.avg_loss.toFixed(2)}`;
            
            // Financial
            document.getElementById('csv-total-volume').textContent = `$${summary.total_volume.toFixed(2)}`;
            document.getElementById('csv-total-fees').textContent = `$${summary.total_fees.toFixed(2)}`;
            document.getElementById('csv-net-profit').textContent = `$${summary.net_profit.toFixed(2)}`;
            document.getElementById('csv-net-profit').className = `font-bold ${summary.net_profit >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            if (summary.best_trade) {
                document.getElementById('csv-best-trade').textContent = `$${summary.best_trade.pnl.toFixed(2)}`;
            }
            
            if (summary.worst_trade) {
                document.getElementById('csv-worst-trade').textContent = `$${summary.worst_trade.pnl.toFixed(2)}`;
            }
            
            // Update charts
            updateCSVCharts(stats);
            
            // Update tables
            updateSymbolTable(stats.by_symbol);
            updateDailyTable(stats.daily);
        }
        
        // ========== CSV CHARTS ==========
        
        function updateCSVCharts(stats) {
            const summary = stats.summary;
            
            // Win Rate Chart
            if (csvWinrateChart) {
                csvWinrateChart.destroy();
            }
            
            const ctx1 = document.getElementById('csv-winrate-chart').getContext('2d');
            csvWinrateChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Ganhos', 'Perdas', 'Breakeven'],
                    datasets: [{
                        data: [
                            summary.winning_trades, 
                            summary.losing_trades,
                            summary.breakeven_trades
                        ],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(156, 163, 175, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
            
            // Cumulative PNL Chart
            if (csvCumulativePNLChart) {
                csvCumulativePNLChart.destroy();
            }
            
            // Calculate cumulative PNL from raw trades
            const trades = stats.raw_trades || [];
            const cumulativeData = [];
            let cumulative = 0;
            
            trades.forEach(trade => {
                cumulative += trade.net_pnl;
                cumulativeData.push(cumulative);
            });
            
            const ctx2 = document.getElementById('csv-cumulative-pnl-chart').getContext('2d');
            csvCumulativePNLChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: trades.map((_, i) => `Trade ${i + 1}`),
                    datasets: [{
                        label: 'PNL Acumulado',
                        data: cumulativeData,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#9ca3af',
                                maxTicksLimit: 10
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#9ca3af',
                                callback: value => `$${value.toFixed(2)}`
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }
        
        // ========== TABLES ==========
        
        function updateSymbolTable(bySymbol) {
            const tbody = document.getElementById('csv-symbol-tbody');
            
            if (!bySymbol || Object.keys(bySymbol).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhum dado dispon√≠vel</td></tr>';
                return;
            }
            
            tbody.innerHTML = Object.entries(bySymbol)
                .sort(([,a], [,b]) => b.pnl - a.pnl)
                .map(([symbol, data]) => `
                    <tr class="border-b border-gray-700">
                        <td class="py-3 font-semibold">${symbol}</td>
                        <td class="py-3">${data.trades}</td>
                        <td class="py-3">${data.win_rate}%</td>
                        <td class="py-3 ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                            $${data.pnl.toFixed(2)}
                        </td>
                        <td class="py-3 text-red-400">$${data.fees.toFixed(2)}</td>
                        <td class="py-3">$${data.volume.toFixed(2)}</td>
                    </tr>
                `).join('');
        }
        
        function updateDailyTable(daily) {
            const tbody = document.getElementById('csv-daily-tbody');
            
            if (!daily || Object.keys(daily).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhum dado dispon√≠vel</td></tr>';
                return;
            }
            
            tbody.innerHTML = Object.entries(daily)
                .sort(([a], [b]) => b.localeCompare(a))
                .map(([date, data]) => `
                    <tr class="border-b border-gray-700">
                        <td class="py-3">${date}</td>
                        <td class="py-3">${data.trades}</td>
                        <td class="py-3">${data.win_rate}%</td>
                        <td class="py-3 ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                            $${data.pnl.toFixed(2)}
                        </td>
                        <td class="py-3">$${data.volume.toFixed(2)}</td>
                    </tr>
                `).join('');
        }
        
        // ========== INIT CSV TAB ==========
        
        async function loadLastAnalysis() {
            try {
                const response = await fetch(`${API_BASE}/api/csv/analysis`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayAnalysis(result.data);
                }
            } catch (error) {
                console.log('Nenhuma an√°lise anterior dispon√≠vel');
            }
        }
        
        // Drag and drop support
        const csvTab = document.getElementById('content-csv-analysis');
        if (csvTab) {
            csvTab.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            csvTab.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.toLowerCase().endsWith('.csv')) {
                    await uploadAndAnalyzeCSV(files[0]);
                } else {
                    showAlert('error', '‚ùå Arquivo deve ser CSV');
                }
            });
        }
        
        console.log('‚úÖ M√≥dulo de An√°lise CSV carregado');
    </script>
</body>
</html>

