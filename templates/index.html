<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 Pacifica Trading Bot - Dashboard v1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .log-line { font-family: monospace; font-size: 0.875rem; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }
        .log-debug { color: #6b7280; }
        .log-success { color: #10b981; }
        
        .pulse-dot { 
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .btn-disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        
        .metric-card {
            transition: transform 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
        }
        
        .alert-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .trade-row-profit { background-color: rgba(16, 185, 129, 0.1); }
        .trade-row-loss { background-color: rgba(239, 68, 68, 0.1); }
        
        .ws-connected { color: #10b981; }
        .ws-disconnected { color: #ef4444; }
        
        .position-long { border-left: 4px solid #10b981; }
        .position-short { border-left: 4px solid #ef4444; }
        
        .order-buy { border-left: 4px solid #3b82f6; }
        .order-sell { border-left: 4px solid #f59e0b; }
        
        #logs-container::-webkit-scrollbar {
            width: 8px;
        }
        
        #logs-container::-webkit-scrollbar-track {
            background: #1f2937;
        }
        
        #logs-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        
        #logs-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Risk Management Styles */
        .risk-manager {
            transition: all 0.3s ease;
        }
        
        .risk-content {
            display: grid;
            gap: 1rem;
        }
        
        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .risk-metric {
            background: rgba(55, 65, 81, 0.5);
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        
        .risk-metric:hover {
            border-color: rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }
        
        .risk-status-safe {
            border-left: 4px solid #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .risk-status-warning {
            border-left: 4px solid #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .risk-status-danger {
            border-left: 4px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .risk-progress {
            width: 100%;
            background: #374151;
            border-radius: 9999px;
            height: 0.5rem;
            overflow: hidden;
        }
        
        .risk-progress-bar {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 9999px;
        }
        
        .risk-progress-safe { background: #10b981; }
        .risk-progress-warning { background: #f59e0b; }
        .risk-progress-danger { background: #ef4444; }
        
        /* Risk Monitor Styles */
        .risk-positions-content {
            display: grid;
            gap: 1rem;
        }
        
        .position-card {
            background: rgba(55, 65, 81, 0.3);
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .position-card:hover {
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        .position-card.risk-level-1 {
            border-left: 4px solid #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
        
        .position-card.risk-level-2 {
            border-left: 4px solid #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }
        
        .position-card.risk-level-3 {
            border-left: 4px solid #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }
        
        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #374151;
        }
        
        .position-symbol {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .position-pnl {
            font-family: monospace;
            font-weight: 600;
        }
        
        .position-pnl.positive { color: #10b981; }
        .position-pnl.negative { color: #ef4444; }
        .position-pnl.neutral { color: #9ca3af; }
        
        .risk-layers {
            display: grid;
            gap: 1rem;
        }
        
        .risk-layer {
            background: rgba(75, 85, 99, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .risk-layer-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }
        
        .risk-items {
            display: grid;
            gap: 0.5rem;
        }
        
        .risk-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(55, 65, 81, 0.3);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .risk-item-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .risk-item-value {
            font-family: monospace;
            font-weight: 500;
        }
        
        .risk-status-indicator {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            display: inline-block;
        }
        
        .risk-item-placeholder {
            padding: 0.75rem;
            background-color: rgba(75, 85, 99, 0.3);
            border: 1px dashed rgba(156, 163, 175, 0.5);
            border-radius: 0.375rem;
            color: #9CA3AF;
            text-align: center;
            font-style: italic;
            font-size: 0.875rem;
        }
        
        .position-card.error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #EF4444;
            text-align: center;
            padding: 1rem;
        }
        
        .status-safe { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-critical { background-color: #ef4444; }
        .status-near-target { background-color: #3b82f6; }
        .status-approaching { background-color: #8b5cf6; }
        
        .risk-progress-container {
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .risk-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }
        
        .risk-progress-bar-container {
            background: #374151;
            height: 0.5rem;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        
        .risk-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .monitor-status-connected {
            color: #10b981;
        }
        
        .monitor-status-disconnected {
            color: #ef4444;
        }
        
        .monitor-status-warning {
            color: #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Alertas Toast -->
    <div id="alerts-container"></div>
    
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Header -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold mb-2">🤖 Pacifica Trading Bot</h1>
                <p class="text-gray-400">Dashboard v1.1 - Configurações Rápidas + Auto-apply</p>
            </div>
            <div class="text-right">
                <div class="flex items-center gap-2 justify-end mb-2">
                    <span class="text-gray-400 text-sm">Auto-Refresh:</span>
                    <div id="refresh-status" class="flex items-center gap-2">
                        <span class="ws-connected">●</span>
                        <span class="text-sm">Ativo (30s)</span>
                    </div>
                </div>
                <div class="text-sm text-gray-500" id="last-update">Última atualização: -</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-4 mb-6 border-b border-gray-700 overflow-x-auto">
            <button onclick="showTab('dashboard')" id="tab-dashboard" 
                    class="px-4 py-2 border-b-2 border-blue-500 text-blue-500 whitespace-nowrap">
                📊 Dashboard
            </button>
            <button onclick="showTab('volume')" id="tab-volume" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                💰 Volume
            </button>
            <button onclick="showTab('trades')" id="tab-trades" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                📋 Histórico
            </button>
            <button onclick="showTab('logs')" id="tab-logs" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                📜 Logs
            </button>
            <button onclick="showTab('csv-analysis')" id="tab-csv-analysis" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                📊 Análise CSV
            </button>
            <button onclick="showTab('config')" id="tab-config" 
                    class="px-4 py-2 text-gray-400 hover:text-white whitespace-nowrap">
                ⚙️ Config
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="content-dashboard">
            <!-- Status Cards e Controles -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gray-800 rounded-lg p-6 metric-card">
                    <p class="text-gray-400 text-sm mb-2">Status</p>
                    <p id="status-text" class="text-2xl font-bold">🔴 Parado</p>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 metric-card">
                    <p class="text-gray-400 text-sm mb-2">PNL Acumulado</p>
                    <p id="pnl-text" class="text-2xl font-bold">$0.00</p>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 metric-card">
                    <p class="text-gray-400 text-sm mb-2">Total Volume</p>
                    <p id="volume-text" class="text-2xl font-bold">$0</p>
                </div>
                <div class="bg-gray-800 rounded-lg p-6 metric-card">
                    <p class="text-gray-400 text-sm mb-2">Controles</p>
                    <div class="flex gap-2 flex-wrap justify-center mt-3">
                        <button id="btn-start" onclick="startBot()" 
                                class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-sm font-semibold">
                            ▶️
                        </button>
                        <button id="btn-stop" onclick="stopBot(false)" disabled
                                class="bg-yellow-600 hover:bg-yellow-700 px-3 py-2 rounded text-sm font-semibold btn-disabled">
                            ⏸️
                        </button>
                        <button id="btn-stop-force" onclick="stopBot(true)" disabled
                                class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-sm font-semibold btn-disabled">
                            🛑
                        </button>
                        <button id="btn-restart" onclick="restartBot()" disabled
                                class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm font-semibold btn-disabled">
                            🔄
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resumo de Posições -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">📊 Resumo</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <p class="text-gray-400 text-sm mb-2">PNL Não Realizado</p>
                        <p id="unrealized-pnl" class="text-2xl font-bold">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm mb-2">PNL Realizado</p>
                        <p id="realized-pnl" class="text-2xl font-bold">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Exposição Total</p>
                        <p id="positions-exposure" class="text-2xl font-bold">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Ordens Pendentes</p>
                        <p id="orders-pending-value" class="text-2xl font-bold">$0.00</p>
                    </div>
                </div>
            </div>

            <!-- Métricas de Conta e Margem -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">💰 Saldo da Conta</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Saldo Total:</span>
                            <span id="account-balance" class="text-2xl font-bold text-blue-400">$0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Última atualização:</span>
                            <span id="balance-updated" class="text-gray-500">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">📊 Margem</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Margem Usada:</span>
                            <span id="margin-used" class="text-orange-400">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Margem Disponível:</span>
                            <span id="margin-available" class="text-green-400">$0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">🎯 Utilização</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-gray-400">Margem Livre:</span>
                                <span id="margin-free-percent" class="text-2xl font-bold text-green-400">0%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="margin-free-bar" class="bg-green-500 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 text-center">
                            <span id="margin-status-text">Monitorando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Posições e Ordens -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Posições Ativas -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">📈 Posições Ativas</h2>
                        <span id="positions-count" class="bg-blue-600 px-3 py-1 rounded text-sm">0</span>
                    </div>
                    <div id="positions-container" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Nenhuma posição ativa</p>
                    </div>
                </div>
                
                <!-- Ordens Abertas -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">📋 Ordens Abertas</h2>
                        <span id="orders-count" class="bg-purple-600 px-3 py-1 rounded text-sm">0</span>
                    </div>
                    <div id="orders-container" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">Nenhuma ordem aberta</p>
                    </div>
                </div>
            </div>

            <!-- DASHBOARD UNIFICADO DE GERENCIAMENTO DE RISCO -->
            <div id="risk-dashboard" class="p-4 bg-gray-900 text-white rounded-2xl shadow-lg mt-4">
              <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                🛡️ Painel de Gerenciamento de Risco
                <span id="risk-status-indicator" class="text-sm font-semibold bg-green-500 px-2 py-1 rounded-lg text-black">Online</span>
              </h2>

              <div class="grid grid-cols-3 gap-4 text-sm font-mono">
                <!-- COLUNA 1: Configurações -->
                <div class="bg-gray-800 p-3 rounded-xl">
                  <h3 class="text-blue-400 font-semibold mb-2">⚙️ Configurações Atuais</h3>
                  <p><strong>Ciclo Stop:</strong> <span id="cfg-cycle-sl">—</span>%</p>
                  <p><strong>Ciclo Take:</strong> <span id="cfg-cycle-tp">—</span>%</p>
                  <p><strong>Emergência SL:</strong> <span id="cfg-emerg-sl">—</span>%</p>
                  <p><strong>Emergência TP:</strong> <span id="cfg-emerg-tp">—</span>%</p>
                  <p><strong>Margem Alvo:</strong> <span id="cfg-margin">—</span>%</p>
                  <p><strong>Max Loss Sessão:</strong> $<span id="cfg-session-loss">—</span></p>
                  <p><strong>Meta Lucro Sessão:</strong> $<span id="cfg-session-profit">—</span></p>
                </div>

                <!-- COLUNA 2: Trade Atual -->
                <div class="bg-gray-800 p-3 rounded-xl">
                  <h3 class="text-green-400 font-semibold mb-2">📊 Trade Ativo</h3>
                  <p><strong>ID:</strong> <span id="trade-id">—</span></p>
                  <p><strong>Ativo:</strong> <span id="trade-symbol">—</span></p>
                  <p><strong>Tipo:</strong> <span id="trade-side">—</span></p>
                  <p><strong>Tempo em Trade:</strong> <span id="trade-time">—</span></p>
                  <p><strong>Preço Atual:</strong> $<span id="trade-price">—</span></p>
                  <p><strong>PNL:</strong> <span id="trade-pnl-usd">$0.00</span> (<span id="trade-pnl-pct">0.00%</span>)</p>
                  <p><strong>Status:</strong> <span id="trade-status">Nenhum trade ativo</span></p>
                </div>

                <!-- COLUNA 3: Sessão -->
                <div class="bg-gray-800 p-3 rounded-xl">
                  <h3 class="text-yellow-400 font-semibold mb-2">📈 Sessão / Saúde</h3>
                  <p><strong>Ciclos:</strong> <span id="session-cycles">0</span></p>
                  <p><strong>PNL Acumulado:</strong> $<span id="session-pnl">0.00</span></p>
                  <p><strong>Margem Atual:</strong> <span id="session-margin">—</span>%</p>
                  <p><strong>Última Verificação:</strong> <span id="session-lastcheck">—</span></p>
                  <p><strong>Flags:</strong> <span id="session-flags">—</span></p>
                </div>
              </div>
            </div>

            <!-- System Info -->
            <div id="system-info" class="bg-gray-800 rounded-lg p-6 hidden">
                <h2 class="text-xl font-semibold mb-4">💻 Informações do Sistema</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <p class="text-gray-400 text-sm">PID</p>
                        <p id="pid-text" class="text-xl font-mono">-</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">CPU</p>
                        <p id="cpu-text" class="text-xl">0%</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Memória</p>
                        <p id="memory-text" class="text-xl">0 MB</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Uptime</p>
                        <p id="uptime-text" class="text-xl">0m</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trades Tab -->
        <div id="content-trades" class="hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">📋 Histórico de Trades</h2>
                    <div class="flex gap-2">
                        <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded flex items-center gap-2">
                            📥 CSV
                        </button>
                        <button onclick="refreshTrades()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            🔄
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left">Data/Hora</th>
                                <th class="px-4 py-3 text-left">Símbolo</th>
                                <th class="px-4 py-3 text-right">PNL USD</th>
                                <th class="px-4 py-3 text-right">PNL %</th>
                                <th class="px-4 py-3 text-right">Duração</th>
                                <th class="px-4 py-3 text-left">Motivo</th>
                                <th class="px-4 py-3 text-right">PNL Acum.</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table-body" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                    Carregando histórico...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-center">
                    <button onclick="loadMoreTrades()" id="btn-load-more" 
                            class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded">
                        Carregar Mais
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs Tab (MELHORADO) -->
        <div id="content-logs" class="hidden">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">📜 Logs (Auto-refresh)</h2>
                    <div class="flex gap-2">
                        <button id="btn-pause-logs" onclick="toggleLogsPause()" 
                                class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded flex items-center gap-2">
                            ⏸️ Pausar
                        </button>
                        <button onclick="refreshLogs()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            🔄 Atualizar
                        </button>
                        <button onclick="clearLogsDisplay()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                            🗑️ Limpar
                        </button>
                    </div>
                </div>
                <div class="bg-yellow-500/10 border border-yellow-500 rounded-lg p-3 mb-4 flex items-center gap-2">
                    <span class="text-yellow-500">⚡</span>
                    <span class="text-sm text-yellow-200" id="logs-status">
                        Auto-refresh ativo (a cada 3s)
                    </span>
                </div>
                <div id="logs-container" class="bg-gray-900 rounded p-4 h-96 overflow-y-auto font-mono text-sm">
                    <p class="text-gray-500">Carregando logs...</p>
                </div>
            </div>
        </div>

        <!-- CSV Analysis Tab -->
        <div id="content-csv-analysis" class="hidden">
            <!-- Upload Section -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">📤 Upload CSV da Pacifica</h2>
                    <button onclick="refreshCSVList()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                        🔄 Atualizar Lista
                    </button>
                </div>
                
                <!-- Upload Form -->
                <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center mb-6">
                    <input type="file" id="csv-file-input" accept=".csv" class="hidden" onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('csv-file-input').click()" 
                            class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold mb-2">
                        📁 Selecionar CSV
                    </button>
                    <p class="text-gray-400 text-sm mt-2">Arraste um arquivo CSV aqui ou clique para selecionar</p>
                    <p class="text-gray-500 text-xs mt-1">Formato aceito: CSV exportado da Pacifica.fi (máx 16MB)</p>
                </div>
                
                <!-- Progress -->
                <div id="upload-progress" class="hidden">
                    <div class="bg-gray-700 rounded-full h-2 mb-2">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p id="upload-status" class="text-sm text-gray-400 text-center">Processando...</p>
                </div>
            </div>
            
            <!-- Available Files -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">📂 Arquivos Disponíveis</h2>
                <div id="csv-files-list" class="space-y-2">
                    <p class="text-gray-500">Carregando...</p>
                </div>
            </div>
            
            <!-- Analysis Results -->
            <div id="csv-analysis-results" class="hidden">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">Total de Trades</p>
                        <p id="csv-total-trades" class="text-3xl font-bold">-</p>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">Win Rate</p>
                        <p id="csv-win-rate" class="text-3xl font-bold">-</p>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">PNL Total</p>
                        <p id="csv-total-pnl" class="text-3xl font-bold">-</p>
                    </div>
                    <div class="bg-gray-800 rounded-lg p-6">
                        <p class="text-gray-400 text-sm mb-2">Profit Factor</p>
                        <p id="csv-profit-factor" class="text-3xl font-bold">-</p>
                    </div>
                </div>
                
                <!-- Detailed Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">📈 Performance</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Trades Ganhos:</span>
                                <span id="csv-winning-trades" class="text-green-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Trades Perdidos:</span>
                                <span id="csv-losing-trades" class="text-red-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Média por Trade:</span>
                                <span id="csv-avg-trade" class="font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Média de Ganho:</span>
                                <span id="csv-avg-win" class="text-green-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Média de Perda:</span>
                                <span id="csv-avg-loss" class="text-red-400 font-bold">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">💰 Financeiro</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Volume Total:</span>
                                <span id="csv-total-volume" class="font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Fees Totais:</span>
                                <span id="csv-total-fees" class="text-red-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Lucro Líquido:</span>
                                <span id="csv-net-profit" class="font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Melhor Trade:</span>
                                <span id="csv-best-trade" class="text-green-400 font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Pior Trade:</span>
                                <span id="csv-worst-trade" class="text-red-400 font-bold">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">📊 Distribuição de Resultados</h3>
                        <canvas id="csv-winrate-chart"></canvas>
                    </div>
                    
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">📈 PNL Acumulado</h3>
                        <canvas id="csv-cumulative-pnl-chart"></canvas>
                    </div>
                </div>
                
                <!-- By Symbol -->
                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">🔍 Performance por Símbolo</h3>
                    <div id="csv-by-symbol" class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="border-b border-gray-700">
                                <tr class="text-left text-gray-400 text-sm">
                                    <th class="pb-3">Símbolo</th>
                                    <th class="pb-3">Trades</th>
                                    <th class="pb-3">Win Rate</th>
                                    <th class="pb-3">PNL</th>
                                    <th class="pb-3">Fees</th>
                                    <th class="pb-3">Volume</th>
                                </tr>
                            </thead>
                            <tbody id="csv-symbol-tbody" class="text-sm">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Daily Stats -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">📅 Performance Diária</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="border-b border-gray-700">
                                <tr class="text-left text-gray-400 text-sm">
                                    <th class="pb-3">Data</th>
                                    <th class="pb-3">Trades</th>
                                    <th class="pb-3">Win Rate</th>
                                    <th class="pb-3">PNL</th>
                                    <th class="pb-3">Volume</th>
                                </tr>
                            </thead>
                            <tbody id="csv-daily-tbody" class="text-sm">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Config Tab v1.1 - MELHORADO -->
        <div id="content-config" class="hidden">
            <!-- Ações Rápidas -->
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">⚙️ Configurações Rápidas</h2>
                    <button onclick="saveConfig()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded font-semibold flex items-center gap-2">
                        💾 Salvar e Aplicar
                    </button>
                </div>
                
                <!-- Estratégia -->
                <div class="bg-gray-700 rounded-lg p-4 mb-4">
                    <label class="block text-gray-300 mb-2 font-semibold">🎯 Estratégia de Trading</label>
                    <select id="config-STRATEGY_TYPE" onchange="toggleStrategyOptions()"
                            class="w-full bg-gray-600 text-white px-4 py-3 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="market_making">📊 Market Making (Grid Dinâmico)</option>
                        <option value="pure_grid">📈 Pure Grid (Grid Fixo)</option>
                        <option value="dynamic_grid">⚡ Dynamic Grid (Grid Adaptativo)</option>
                        <option value="multi_asset">🌐 Multi Asset (Múltiplos Pares)</option>
                        <option value="multi_asset_enhanced">🚀 Multi Asset Enhanced (Avançado)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2">
                        💡 <strong>Market Making:</strong> Grid que se ajusta ao mercado |
                        <strong>Pure Grid:</strong> Níveis fixos |
                        <strong>Dynamic:</strong> Adaptativo |
                        <strong>Multi Asset:</strong> Vários ativos simultâneos
                    </p>
                </div>
                
                <!-- Opções de Grid (visível quando STRATEGY = grid) -->
                <div id="grid-options" class="space-y-4">
                    <h3 class="text-lg font-semibold text-blue-400 mb-3">� Configurações do Grid</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Symbol -->
                        <div>
                            <label class="block text-gray-300 mb-2">💱 Símbolo</label>
                            <input type="text" id="config-SYMBOL" placeholder="Ex: SOL"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">Par de trading (SOL, BTC, ETH...)</p>
                        </div>
                        
                        <!-- Grid Levels -->
                        <div>
                            <label class="block text-gray-300 mb-2">🔢 Níveis do Grid</label>
                            <input type="number" id="config-GRID_LEVELS" min="3" max="20" placeholder="Ex: 8"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">Número de ordens (3-20)</p>
                        </div>
                        
                        <!-- Order Size -->
                        <div>
                            <label class="block text-gray-300 mb-2">💵 Tamanho da Ordem (USD)</label>
                            <input type="number" id="config-ORDER_SIZE_USD" min="1" step="0.01" placeholder="Ex: 100"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">Valor em USD por ordem</p>
                        </div>
                        
                        <!-- Grid Spacing -->
                        <div>
                            <label class="block text-gray-300 mb-2">📏 Espaçamento do Grid (%)</label>
                            <input type="number" id="config-GRID_SPACING_PERCENT" min="0.1" max="5" step="0.1" placeholder="Ex: 0.2"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">Distância entre níveis (0.1% - 5%)</p>
                        </div>
                        
                        <!-- Max Position -->
                        <div>
                            <label class="block text-gray-300 mb-2">🛡️ Posição Máxima (USD)</label>
                            <input type="number" id="config-MAX_POSITION_SIZE_USD" min="0" step="0.01" placeholder="Ex: 1000"
                                   class="w-full bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-400 mt-1">Limite de exposição total</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Configurações Avançadas (Collapsible) -->
            <div class="bg-gray-800 rounded-lg p-6">
                <button onclick="toggleAdvancedConfig()" class="w-full flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">🔧 Configurações Avançadas</h2>
                    <span id="advanced-toggle-icon" class="text-2xl">▼</span>
                </button>
                <div id="advanced-config-container" class="space-y-4 hidden">
                    <p class="text-gray-500">Carregando configurações avançadas...</p>
                </div>
            </div>
        </div>

        <!-- Volume Tab -->
        <div id="content-volume" class="hidden">
            <!-- Cards de Volume por Período -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-4 metric-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-gray-400 text-sm">Última Hora</p>
                    <span id="volume-1h-change" class="text-xs px-2 py-1 rounded bg-gray-700">-</span>
                </div>
                <p id="volume-1h" class="text-2xl font-bold text-blue-400">$0.00</p>
                <p class="text-gray-500 text-xs mt-1">
                    <span id="volume-1h-trades">0</span> trades
                </p>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4 metric-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-gray-400 text-sm">Últimas 24h</p>
                    <span id="volume-24h-change" class="text-xs px-2 py-1 rounded bg-gray-700">-</span>
                </div>
                <p id="volume-24h" class="text-2xl font-bold text-green-400">$0.00</p>
                <p class="text-gray-500 text-xs mt-1">
                    <span id="volume-24h-trades">0</span> trades
                </p>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4 metric-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-gray-400 text-sm">Última Semana</p>
                    <span id="volume-7d-change" class="text-xs px-2 py-1 rounded bg-gray-700">-</span>
                </div>
                <p id="volume-7d" class="text-2xl font-bold text-purple-400">$0.00</p>
                <p class="text-gray-500 text-xs mt-1">
                    <span id="volume-7d-trades">0</span> trades
                </p>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4 metric-card">
                <div class="flex justify-between items-start mb-2">
                    <p class="text-gray-400 text-sm">Últimos 14 dias</p>
                    <span id="volume-14d-change" class="text-xs px-2 py-1 rounded bg-gray-700">-</span>
                </div>
                <p id="volume-14d" class="text-2xl font-bold text-yellow-400">$0.00</p>
                <p class="text-gray-500 text-xs mt-1">
                    <span id="volume-14d-trades">0</span> trades
                </p>
            </div>
        </div>
        
        <!-- Métricas Detalhadas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-4">💵 Financeiro (24h)</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Volume Total:</span>
                        <span id="volume-total-24h" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Fees Pagos:</span>
                        <span id="volume-fees-24h" class="text-red-400 font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">PNL Total:</span>
                        <span id="volume-pnl-24h" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Avg por Trade:</span>
                        <span id="volume-avg-24h" class="font-bold">$0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-4">📊 Por Símbolo (24h)</h3>
                <div id="volume-by-symbol" class="space-y-2 max-h-40 overflow-y-auto">
                    <p class="text-gray-500 text-sm">Carregando...</p>
                </div>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-4">🔄 Por Direção (24h)</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-green-400">🟢 Open Long:</span>
                        <span id="volume-open-long" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-red-400">🔴 Open Short:</span>
                        <span id="volume-open-short" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-blue-400">🔵 Close Long:</span>
                        <span id="volume-close-long" class="font-bold">$0.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-yellow-400">🟡 Close Short:</span>
                        <span id="volume-close-short" class="font-bold">$0.00</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gráfico de Timeline -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold">📈 Evolução do Volume</h2>
                <div class="flex gap-2">
                    <button onclick="loadVolumeTimeline(6, 60)" 
                            class="px-3 py-1 bg-gray-700 rounded text-sm hover:bg-gray-600">
                        6h
                    </button>
                    <button onclick="loadVolumeTimeline(24, 60)" 
                            class="px-3 py-1 bg-blue-600 rounded text-sm hover:bg-blue-700">
                        24h
                    </button>
                    <button onclick="loadVolumeTimeline(168, 360)" 
                            class="px-3 py-1 bg-gray-700 rounded text-sm hover:bg-gray-600">
                        7d
                    </button>
                    <button onclick="loadVolumeTimeline(336, 720)" 
                            class="px-3 py-1 bg-gray-700 rounded text-sm hover:bg-gray-600">
                        14d
                    </button>
                </div>
            </div>
            <div style="height: 300px; position: relative;">
                <canvas id="volume-timeline-chart"></canvas>
            </div>
        </div>
        
        <!-- Comparação com Período Anterior -->
        <div class="bg-gray-800 rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-4">📊 Comparação de Performance</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-sm text-gray-400 mb-3">Período Atual (24h)</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Volume:</span>
                            <span id="comparison-current-volume" class="font-bold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Trades:</span>
                            <span id="comparison-current-trades" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>PNL:</span>
                            <span id="comparison-current-pnl" class="font-bold">$0.00</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-sm text-gray-400 mb-3">Período Anterior (24h)</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Volume:</span>
                            <span id="comparison-previous-volume" class="font-bold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Trades:</span>
                            <span id="comparison-previous-trades" class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>PNL:</span>
                            <span id="comparison-previous-pnl" class="font-bold">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-700">
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Variação:</span>
                    <div class="flex items-center gap-2">
                        <span id="comparison-change-absolute" class="font-bold">$0.00</span>
                        <span id="comparison-change-percent" class="px-3 py-1 rounded font-bold">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>  <!-- Fecha o container principal mx-auto p-4 max-w-7xl -->

    <script>
        // Estado Global
        const API_BASE = window.location.origin;
        let socket = null;
        let currentTab = 'dashboard';
        let pnlChart = null;
        let volumeTimelineChart = null;
        let winrateChart = null;
        let pnlDistChart = null;
        let tradesLimit = 50;
        let logsPaused = false;
        let logsAutoScroll = true;
        
        console.log('🚀 Dashboard v1.1 iniciado');

        // ========== WEBSOCKET ==========
        
        function initWebSocket() {
            console.log('🔌 Iniciando conexão WebSocket com:', API_BASE);
            
            socket = io(API_BASE, {
                transports: ['polling'],
                upgrade: false,
                rememberUpgrade: false,
                timeout: 20000,
                forceNew: true
            });
            
            socket.on('connect', () => {
                console.log('✅ WebSocket conectado - ID:', socket.id);
                updateWSStatus(true);
                showAlert('success', '🔌 Conectado ao servidor');
            });
            
            socket.on('disconnect', (reason) => {
                console.log('❌ WebSocket desconectado - Motivo:', reason);
                updateWSStatus(false);
                showAlert('error', '🔌 Desconectado do servidor');
            });
            
            socket.on('connect_error', (error) => {
                console.error('❌ Erro de conexão WebSocket:', error.message);
                updateWSStatus(false);
            });
            
            socket.on('bot_status_update', (data) => {
                updateBotStatus(data);
            });
            
            socket.on('metrics_update', (data) => {
                updateMetrics(data);
            });
            
            socket.on('pnl_history_update', (data) => {
                updatePNLChartData(data);
            });
            
            // NOVO: Posições e Ordens
            socket.on('positions_update', (data) => {
                updatePositions(data);
            });
            
            socket.on('orders_update', (data) => {
                updateOrders(data);
            });
            
            // NOVO: Logs auto-refresh
            socket.on('logs_update', (data) => {
                if (!logsPaused) {
                    updateLogsDisplay(data);
                }
            });
            
            socket.on('alert', (data) => {
                showAlert(data.type, data.message);
            });
            
            // NOVO: Risk Management Updates
            socket.on('risk_update', (data) => {
                if (currentTab === 'dashboard') {
                    updateRiskDisplay(data);
                }
            });
        }
        
        function updateWSStatus(connected) {
            // Auto-refresh está sempre ativo - não precisa atualizar status
        }

        // ========== ALERTS ==========
        
        function showAlert(type, message) {
            const container = document.getElementById('alerts-container');
            const id = 'alert-' + Date.now();
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            const alert = document.createElement('div');
            alert.id = id;
            alert.className = `alert-toast ${colors[type] || colors.info} text-white px-6 py-4 rounded-lg shadow-lg mb-2`;
            alert.innerHTML = `
                <div class="flex items-center justify-between gap-4">
                    <span>${message}</span>
                    <button onclick="closeAlert('${id}')" class="text-white hover:text-gray-200">✕</button>
                </div>
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                closeAlert(id);
            }, 5000);
        }
        
        function closeAlert(id) {
            const alert = document.getElementById(id);
            if (alert) {
                alert.classList.add('fade-out');
                setTimeout(() => alert.remove(), 300);
            }
        }

        // ========== TABS ==========
        
        function showTab(tab) {
            currentTab = tab;
            
            ['dashboard', 'volume', 'positions', 'charts', 'trades', 'logs', 'csv-analysis', 'config'].forEach(t => {
                const contentEl = document.getElementById(`content-${t}`);
                const tabEl = document.getElementById(`tab-${t}`);
                
                if (contentEl) {
                    contentEl.classList.add('hidden');
                }
                if (tabEl) {
                    tabEl.classList.remove('border-blue-500', 'text-blue-500');
                    tabEl.classList.add('text-gray-400');
                }
            });
            
            const activeContent = document.getElementById(`content-${tab}`);
            const activeTab = document.getElementById(`tab-${tab}`);
            
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
            if (activeTab) {
                activeTab.classList.add('border-blue-500', 'text-blue-500');
                activeTab.classList.remove('text-gray-400');
            }
            
            if (window.positionsInterval) {
                clearInterval(window.positionsInterval);
                window.positionsInterval = null;
            }
            if (tab === 'dashboard') {
                loadPositionsAndOrders();
                updateRiskDashboard();
                // loadRiskPositionsMonitor();
            } else if (tab === 'volume') {
                loadVolumeStats();
                loadVolumeTimeline(24, 60);
                loadVolumeComparison('24h');
            } else if (tab === 'charts') {
                initCharts();
            } else if (tab === 'trades') {
                loadTrades();
            } else if (tab === 'logs') {
                refreshLogs();
            } else if (tab === 'csv-analysis') {
                refreshCSVList();
                if (!currentAnalysis) {
                    loadLastAnalysis();
                }
            } else if (tab === 'config') {
                loadConfig();
            } else if (tab === 'positions') {
                loadPositionsAndOrders();
                window.positionsInterval = setInterval(() => {
                    if (currentTab === 'positions') {
                        loadPositionsAndOrders();
                    }
                }, 30000); // 30 segundos
            }
        }

        // ========== HISTÓRICO ==========
        async function loadHistoricalStats() {
    try {
        const response = await fetch(`${API_BASE}/api/historical-stats`);
        const data = await response.json();
        renderDailyPNLChart(data);
    } catch (error) {
        console.error('Erro ao carregar histórico:', error);
    }
}

function renderDailyPNLChart(data) {
    const ctx = document.getElementById('daily-pnl-chart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.days,
            datasets: [
                {
                    label: 'PNL Diário (USD)',
                    data: data.pnl,
                    backgroundColor: data.pnl.map(v => v >= 0 ? 'rgba(34,197,94,0.8)' : 'rgba(239,68,68,0.8)')
                },
                {
                    label: 'Volume (USD)',
                    data: data.volume,
                    backgroundColor: 'rgba(59,130,246,0.3)',
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { labels: { color: '#fff' } },
                title: { display: true, text: 'Estatísticas Diárias - PNL e Volume', color: '#fff' }
            },
            scales: {
                x: { ticks: { color: '#9ca3af' } },
                y: { ticks: { color: '#9ca3af' }, beginAtZero: true },
                y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#9ca3af' } }
            }
        }
    });
}

        // ========== BOT CONTROLS ==========
        
        async function startBot() {
            try {
                showAlert('info', '⏳ Iniciando bot...');
                const response = await fetch(`${API_BASE}/api/bot/start`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', result.message);
                } else {
                    showAlert('error', result.message);
                }
            } catch (error) {
                console.error('❌ Erro ao iniciar bot:', error);
                showAlert('error', 'Erro ao iniciar bot: ' + error.message);
            }
        }
        
        async function stopBot(force) {
            try {
                showAlert('info', force ? '⏳ Parando bot (forçado)...' : '⏳ Parando bot...');
                const response = await fetch(`${API_BASE}/api/bot/stop`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({force})
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', result.message);
                } else {
                    showAlert('error', result.message);
                }
            } catch (error) {
                console.error('❌ Erro ao parar bot:', error);
                showAlert('error', 'Erro ao parar bot: ' + error.message);
            }
        }
        
        async function restartBot() {
            try {
                showAlert('info', '⏳ Reiniciando bot...');
                const response = await fetch(`${API_BASE}/api/bot/restart`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', result.message);
                } else {
                    showAlert('error', result.message);
                }
            } catch (error) {
                console.error('❌ Erro ao reiniciar bot:', error);
                showAlert('error', 'Erro ao reiniciar bot: ' + error.message);
            }
        }

        // ========== UPDATE FUNCTIONS ==========
        
        function updateBotStatus(data) {
            const statusText = document.getElementById('status-text');
            const btnStart = document.getElementById('btn-start');
            const btnStop = document.getElementById('btn-stop');
            const btnStopForce = document.getElementById('btn-stop-force');
            const btnRestart = document.getElementById('btn-restart');
            const systemInfo = document.getElementById('system-info');
            
            if (data.running) {
                statusText.innerHTML = '🟢 Rodando <span class="pulse-dot">●</span>';
                btnStart.disabled = true;
                btnStart.classList.add('btn-disabled');
                btnStop.disabled = false;
                btnStop.classList.remove('btn-disabled');
                btnStopForce.disabled = false;
                btnStopForce.classList.remove('btn-disabled');
                btnRestart.disabled = false;
                btnRestart.classList.remove('btn-disabled');
                systemInfo.classList.remove('hidden');
                
                document.getElementById('pid-text').textContent = data.pid || '-';
                document.getElementById('cpu-text').textContent = (data.cpu_percent || 0).toFixed(1) + '%';
                document.getElementById('memory-text').textContent = (data.memory_mb || 0).toFixed(0) + ' MB';
                document.getElementById('uptime-text').textContent = formatUptime(data.uptime_seconds || 0);
            } else {
                statusText.textContent = '🔴 Parado';
                btnStart.disabled = false;
                btnStart.classList.remove('btn-disabled');
                btnStop.disabled = true;
                btnStop.classList.add('btn-disabled');
                btnStopForce.disabled = true;
                btnStopForce.classList.add('btn-disabled');
                btnRestart.disabled = true;
                btnRestart.classList.add('btn-disabled');
                systemInfo.classList.add('hidden');
            }
            
            document.getElementById('last-update').textContent = 
                'Última atualização: ' + new Date().toLocaleTimeString('pt-BR');
        }
        
        function updateMetrics(data) {
            // Verificar se os elementos existem antes de tentar atualizá-los
            const pnlElement = document.getElementById('pnl-text');
            const cyclesElement = document.getElementById('cycles-text');
            const winrateElement = document.getElementById('winrate-text');
            const totalTradesElement = document.getElementById('total-trades');
            const winningTradesElement = document.getElementById('winning-trades');
            const losingTradesElement = document.getElementById('losing-trades');
            const avgWinElement = document.getElementById('avg-win');
            
            if (pnlElement) {
                const pnl = data?.accumulated_pnl || 0;
                pnlElement.textContent = `$${pnl.toFixed(2)}`;
                pnlElement.className = `text-2xl font-bold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            }
            
            if (cyclesElement) {
                cyclesElement.textContent = data?.cycles_closed || 0;
            }
            
            if (winrateElement) {
                const winRate = data?.win_rate || 0;
                winrateElement.textContent = `${winRate}%`;
                winrateElement.className = `text-2xl font-bold ${winRate >= 50 ? 'text-green-400' : 'text-yellow-400'}`;
            }
            
            if (totalTradesElement) {
                totalTradesElement.textContent = data?.total_trades || 0;
            }
            
            if (winningTradesElement) {
                winningTradesElement.textContent = data?.winning_trades || 0;
            }
            
            if (losingTradesElement) {
                losingTradesElement.textContent = data?.losing_trades || 0;
            }
            
            if (avgWinElement) {
                avgWinElement.textContent = `$${(data?.avg_win || 0).toFixed(2)}`;
            }
            document.getElementById('avg-loss').textContent = `$${(data.avg_loss || 0).toFixed(2)}`;
            document.getElementById('profit-factor').textContent = (data.profit_factor || 0).toFixed(2);
            document.getElementById('profit-factor').className = data.profit_factor >= 1 ? 'text-green-400' : 'text-red-400';
            
            document.getElementById('largest-win').textContent = `$${(data.largest_win || 0).toFixed(2)}`;
            document.getElementById('largest-loss').textContent = `$${(data.largest_loss || 0).toFixed(2)}`;
            document.getElementById('current-balance').textContent = `$${(data.current_balance || 0).toFixed(2)}`;
            
            if (currentTab === 'charts') {
                updateDistributionCharts(data);
            }
        }
        
        function formatUptime(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
            return `${Math.floor(seconds / 86400)}d ${Math.floor((seconds % 86400) / 3600)}h`;
        }

        // ========== POSIÇÕES E ORDENS (NOVO) ==========
        
        async function loadPositionsAndOrders() {
            try {
                console.log('🔄 Carregando posições, ordens e estado da conta...');
                const [posRes, ordRes, accRes] = await Promise.all([
                    fetch(`${API_BASE}/api/positions`),
                    fetch(`${API_BASE}/api/orders`),
                    fetch(`${API_BASE}/api/account-state`)
                ]);
                
                const positions = await posRes.json();
                const orders = await ordRes.json();
                const accountState = await accRes.json();
                
                console.log('📊 Posições recebidas:', positions.length, positions);
                console.log('📋 Ordens recebidas:', orders.length, orders);
                console.log('💰 Estado da conta:', accountState);
                
                updatePositions(positions);
                updateOrders(orders);
                updateAccountState(accountState);
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
            }
        }
        
        function updatePositions(positions) {
            console.log('🔄 updatePositions chamada com:', positions.length, 'posições');
            const container = document.getElementById('positions-container');
            const countEl = document.getElementById('positions-count');
            if (countEl) countEl.textContent = positions.length;

            if (positions.length === 0) {
                if (container) container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma posição ativa</p>';
                const totalPnlEl = document.getElementById('positions-total-pnl');
                if (totalPnlEl) totalPnlEl.textContent = '$0.00';
                const exposureEl = document.getElementById('positions-exposure');
                if (exposureEl) exposureEl.textContent = '$0.00';
                return;
            }
            
            let unrealizedPnl = 0;
            let realizedPnl = 0;
            let totalExposure = 0;

            if (container) container.innerHTML = positions.map(pos => {
                // Converter strings para números
                const pnl = parseFloat(pos.pnl_usd || pos.unrealized_pnl || 0);
                const size = parseFloat(pos.size || pos.amount || 0);
                const entryPrice = parseFloat(pos.entry_price || pos.avg_price || 0);
                const currentPrice = parseFloat(pos.current_price || entryPrice || 0);
                const pnlPercent = parseFloat(pos.pnl_percent || 0);

                // PNL não realizado: posições abertas
                unrealizedPnl += pnl;
                // PNL realizado: histórico fechado (se vier no objeto)
                if (pos.realized_pnl) {
                    realizedPnl += parseFloat(pos.realized_pnl);
                }

                totalExposure += entryPrice * size;

                const pnlClass = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const sideClass = (pos.side || '').toLowerCase().includes('long') ? 'position-long' : 'position-short';
                const sideLabel = (pos.side || '').toLowerCase().includes('long') ? '🟢 LONG' : '🔴 SHORT';

                return `
                    <div class="bg-gray-700 rounded-lg p-4 ${sideClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-bold text-lg">${pos.symbol || '-'}</span>
                                <span class="ml-2 text-sm">${sideLabel}</span>
                            </div>
                            <span class="${pnlClass} font-bold">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-400">Tamanho:</span>
                                <span class="ml-1">${size.toFixed(4)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Entrada:</span>
                                <span class="ml-1">$${entryPrice.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Atual:</span>
                                <span class="ml-1">$${currentPrice.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Ativo há:</span>
                                <span class="ml-1">${pos.duration_str || '-'}</span>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-600">
                            <span class="text-gray-400 text-xs">PNL: </span>
                            <span class="${pnlClass} text-sm font-semibold">
                                ${pnlPercent.toFixed(2)}%
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            const unrealizedEl = document.getElementById('unrealized-pnl');
            if (unrealizedEl) {
                unrealizedEl.textContent = `$${unrealizedPnl.toFixed(2)}`;
                unrealizedEl.className = `text-2xl font-bold ${unrealizedPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            }
            const realizedEl = document.getElementById('realized-pnl');
            if (realizedEl) {
                realizedEl.textContent = `$${realizedPnl.toFixed(2)}`;
                realizedEl.className = `text-2xl font-bold ${realizedPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            }
            const exposureEl = document.getElementById('positions-exposure');
            if (exposureEl) exposureEl.textContent = `$${totalExposure.toFixed(2)}`;
        }
        
        function updateOrders(orders) {
            console.log('🔄 updateOrders chamada com:', orders.length, 'ordens');
            const container = document.getElementById('orders-container');
            const countEl = document.getElementById('orders-count');
            if (countEl) countEl.textContent = orders.length;

            if (orders.length === 0) {
                if (container) container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma ordem aberta</p>';
                const pendingValueEl = document.getElementById('orders-pending-value');
                if (pendingValueEl) pendingValueEl.textContent = '$0.00';
                return;
            }
            
            let totalValue = 0;
            let buyOrders = 0;
            let sellOrders = 0;
            
            if (container) container.innerHTML = orders.map(order => {
                // Converter strings para números
                const price = parseFloat(order.price || 0);
                const size = parseFloat(order.size || order.initial_amount || 0);
                const value = price * size;
                totalValue += value;
                
                const side = (order.side || '').toLowerCase();
                if (side.includes('buy') || side === 'bid') {
                    buyOrders++;
                } else {
                    sellOrders++;
                }
                
                const sideClass = side.includes('buy') || side === 'bid' ? 'order-buy' : 'order-sell';
                const sideLabel = side.includes('buy') || side === 'bid' ? '🔵 BUY' : '🟠 SELL';
                
                return `
                    <div class="bg-gray-700 rounded-lg p-4 ${sideClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-bold">${order.symbol || '-'}</span>
                                <span class="ml-2 text-sm">${sideLabel}</span>
                            </div>
                            <span class="text-gray-400 text-sm">${order.age_str || '-'}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-400">Preço:</span>
                                <span class="ml-1">$${price.toFixed(2)}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Tamanho:</span>
                                <span class="ml-1">${size.toFixed(4)}</span>
                            </div>
                            <div class="col-span-2">
                                <span class="text-gray-400">Valor:</span>
                                <span class="ml-1 font-semibold">$${value.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            const pendingValueEl = document.getElementById('orders-pending-value');
            if (pendingValueEl) pendingValueEl.textContent = `$${totalValue.toFixed(2)}`;
            
            // Calcular % do grid preenchido (buy + sell orders) - DESABILITADO: elemento não existe no HTML
            // const totalOrders = buyOrders + sellOrders;
            // const gridFillPercent = totalOrders > 0 ? ((buyOrders + sellOrders) / (totalOrders * 2)) * 100 : 0;
            // const gridFillEl = document.getElementById('grid-fill-percent');
            // if (gridFillEl) gridFillEl.textContent = `${gridFillPercent.toFixed(0)}%`;
        }
        
        function updateAccountState(state) {
            console.log('💰 Atualizando estado da conta:', state);
            
            // Saldo
            const balanceEl = document.getElementById('account-balance');
            if (balanceEl) {
                balanceEl.textContent = `$${(state.balance || 0).toFixed(2)}`;
            }
            
            // Margem Usada
            const marginUsedEl = document.getElementById('margin-used');
            if (marginUsedEl) {
                marginUsedEl.textContent = `$${(state.margin_used || 0).toFixed(2)}`;
            }
            
            // Margem Disponível
            const marginAvailableEl = document.getElementById('margin-available');
            if (marginAvailableEl) {
                marginAvailableEl.textContent = `$${(state.margin_available || 0).toFixed(2)}`;
            }
            
            // Margem Livre (%)
            const marginFreePercent = state.margin_free_percent || 0;
            const marginFreePercentEl = document.getElementById('margin-free-percent');
            if (marginFreePercentEl) {
                marginFreePercentEl.textContent = `${marginFreePercent.toFixed(1)}%`;
                
                // Alterar cor baseado no percentual
                if (marginFreePercent < 20) {
                    marginFreePercentEl.className = 'text-2xl font-bold text-red-400';
                } else if (marginFreePercent < 50) {
                    marginFreePercentEl.className = 'text-2xl font-bold text-orange-400';
                } else {
                    marginFreePercentEl.className = 'text-2xl font-bold text-green-400';
                }
            }
            
            // Barra de progresso
            const marginFreeBarEl = document.getElementById('margin-free-bar');
            if (marginFreeBarEl) {
                marginFreeBarEl.style.width = `${marginFreePercent}%`;
                
                // Alterar cor da barra baseado no percentual
                if (marginFreePercent < 20) {
                    marginFreeBarEl.className = 'bg-red-500 h-2 rounded-full transition-all';
                } else if (marginFreePercent < 50) {
                    marginFreeBarEl.className = 'bg-orange-500 h-2 rounded-full transition-all';
                } else {
                    marginFreeBarEl.className = 'bg-green-500 h-2 rounded-full transition-all';
                }
            }
            
            // Texto de status
            const marginStatusEl = document.getElementById('margin-status-text');
            if (marginStatusEl) {
                if (marginFreePercent < 20) {
                    marginStatusEl.textContent = '⚠️ Margem Crítica - Risco Alto';
                    marginStatusEl.className = 'text-xs text-red-400 text-center font-semibold';
                } else if (marginFreePercent < 50) {
                    marginStatusEl.textContent = '⚡ Atenção - Margem Média';
                    marginStatusEl.className = 'text-xs text-orange-400 text-center';
                } else {
                    marginStatusEl.textContent = '✅ Margem Saudável';
                    marginStatusEl.className = 'text-xs text-green-400 text-center';
                }
            }
            
            // Última atualização
            const balanceUpdatedEl = document.getElementById('balance-updated');
            if (balanceUpdatedEl && state.last_update) {
                const updateTime = new Date(state.last_update);
                const now = new Date();
                const diffSeconds = Math.floor((now - updateTime) / 1000);
                
                let timeText;
                if (diffSeconds < 60) {
                    timeText = 'agora mesmo';
                } else if (diffSeconds < 3600) {
                    timeText = `há ${Math.floor(diffSeconds / 60)}min`;
                } else {
                    timeText = updateTime.toLocaleTimeString('pt-BR');
                }
                balanceUpdatedEl.textContent = timeText;
            }
        }

        // ========== LOGS COM AUTO-REFRESH (MELHORADO) ==========
        
        function toggleLogsPause() {
            logsPaused = !logsPaused;
            const btn = document.getElementById('btn-pause-logs');
            const status = document.getElementById('logs-status');
            
            if (logsPaused) {
                btn.innerHTML = '▶️ Retomar';
                btn.className = 'bg-green-600 hover:bg-green-700 px-4 py-2 rounded flex items-center gap-2';
                status.textContent = 'Auto-refresh PAUSADO';
            } else {
                btn.innerHTML = '⏸️ Pausar';
                btn.className = 'bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded flex items-center gap-2';
                status.textContent = 'Auto-refresh ativo (a cada 3s)';
                refreshLogs(); // Atualizar imediatamente ao retomar
            }
        }
        
        async function refreshLogs() {
            try {
                const response = await fetch(`${API_BASE}/api/logs?lines=200`);
                const data = await response.json();
                updateLogsDisplay(data);
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
            }
        }
        
        function updateLogsDisplay(data) {
            const container = document.getElementById('logs-container');
            
            // Verificar se usuário está no final (para auto-scroll inteligente)
            const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
            
            container.innerHTML = data.logs.map(line => {
                let className = 'log-line';
                if (line.includes('ERROR') || line.includes('❌')) className += ' log-error';
                else if (line.includes('WARNING') || line.includes('⚠️')) className += ' log-warning';
                else if (line.includes('INFO') || line.includes('✅')) className += ' log-info';
                else if (line.includes('DEBUG')) className += ' log-debug';
                
                return `<div class="${className}">${line}</div>`;
            }).join('');
            
            // Auto-scroll INTELIGENTE: só faz scroll se usuário estava no final
            if (wasAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function clearLogsDisplay() {
            document.getElementById('logs-container').innerHTML = '<p class="text-gray-500">Logs limpos. Clique em Atualizar para recarregar.</p>';
        }

        // ========== CHARTS ==========
        
        function initCharts() {
            if (!pnlChart) {
                const ctx = document.getElementById('pnl-chart').getContext('2d');
                pnlChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'PNL Acumulado',
                            data: [],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
            
            if (!winrateChart) {
                const ctx2 = document.getElementById('winrate-chart').getContext('2d');
                winrateChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ganhos', 'Perdas'],
                        datasets: [{
                            data: [0, 0],
                            backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } },
                            title: {
                                display: true,
                                text: 'Win Rate',
                                color: '#fff'
                            }
                        }
                    }
                });
            }
            
            if (!pnlDistChart) {
                const ctx3 = document.getElementById('pnl-distribution-chart').getContext('2d');
                pnlDistChart = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['< -$10', '-$10 a -$5', '-$5 a $0', '$0 a $5', '$5 a $10', '> $10'],
                        datasets: [{
                            label: 'Número de Trades',
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(251, 146, 60, 0.8)',
                                'rgba(250, 204, 21, 0.8)',
                                'rgba(132, 204, 22, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(16, 185, 129, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { labels: { color: '#fff' } },
                            title: {
                                display: true,
                                text: 'Distribuição de PNL',
                                color: '#fff'
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            }
        }
        
        function updatePNLChartData(data) {
            if (!pnlChart) return;
            
            const labels = data.map(d => {
                const date = new Date(d.timestamp);
                return date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            });
            
            const values = data.map(d => d.accumulated);
            
            pnlChart.data.labels = labels;
            pnlChart.data.datasets[0].data = values;
            pnlChart.update();
        }
        
        function updateDistributionCharts(metrics) {
            if (winrateChart) {
                winrateChart.data.datasets[0].data = [
                    metrics.winning_trades || 0,
                    metrics.losing_trades || 0
                ];
                winrateChart.update();
            }
        }
        
        async function updatePNLChart(hours) {
            try {
                const response = await fetch(`${API_BASE}/api/pnl-history?hours=${hours}`);
                const data = await response.json();
                updatePNLChartData(data);
            } catch (error) {
                console.error('Erro ao atualizar gráfico PNL:', error);
            }
        }
        
        async function loadPNLHistory(hours) {
            try {
                const response = await fetch(`${API_BASE}/api/pnl-history?hours=${hours}`);
                const data = await response.json();
                updatePNLChartData(data);
            } catch (error) {
                console.error('Erro ao carregar histórico PNL:', error);
            }
        }

        // ========== TRADES ==========
        
        async function loadTrades() {
            try {
                const response = await fetch(`${API_BASE}/api/trades?limit=${tradesLimit}`);
                const trades = await response.json();
                
                const tbody = document.getElementById('trades-table-body');
                
                if (trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Nenhum trade registrado</td></tr>';
                    return;
                }
                
                tbody.innerHTML = trades.map(trade => {
                    const timestamp = new Date(trade.timestamp).toLocaleString('pt-BR');
                    const pnl = trade.pnl_usd || 0;
                    const pnlClass = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                    const rowClass = pnl >= 0 ? 'trade-row-profit' : 'trade-row-loss';
                    
                    return `
                        <tr class="${rowClass}">
                            <td class="px-4 py-3">${timestamp}</td>
                            <td class="px-4 py-3">${trade.symbol || '-'}</td>
                            <td class="px-4 py-3 text-right ${pnlClass} font-semibold">$${pnl.toFixed(2)}</td>
                            <td class="px-4 py-3 text-right ${pnlClass}">${(trade.pnl_percent || 0).toFixed(2)}%</td>
                            <td class="px-4 py-3 text-right">${(trade.duration_minutes || 0).toFixed(1)}min</td>
                            <td class="px-4 py-3">${trade.reason || '-'}</td>
                            <td class="px-4 py-3 text-right">${(trade.accumulated_pnl || 0).toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar trades:', error);
                showAlert('error', 'Erro ao carregar histórico de trades');
            }
        }
        
        function refreshTrades() {
            tradesLimit = 50;
            loadTrades();
        }
        
        function loadMoreTrades() {
            tradesLimit += 50;
            loadTrades();
        }

        // ========== CONFIG v1.1 ==========
        
        function toggleStrategyOptions() {
            const strategy = document.getElementById('config-STRATEGY_TYPE').value;
            const gridOptions = document.getElementById('grid-options');
            
            // Mostrar opções de grid para todas as estratégias baseadas em grid
            const gridBasedStrategies = ['market_making', 'pure_grid', 'dynamic_grid'];
            
            if (gridBasedStrategies.includes(strategy)) {
                gridOptions.classList.remove('hidden');
            } else {
                // Multi Asset strategies não usam as mesmas configs de grid
                gridOptions.classList.add('hidden');
            }
        }
        
        function toggleAdvancedConfig() {
            const container = document.getElementById('advanced-config-container');
            const icon = document.getElementById('advanced-toggle-icon');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                icon.textContent = '▲';
            } else {
                container.classList.add('hidden');
                icon.textContent = '▼';
            }
        }
        
        async function loadConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/config`);
                const config = await response.json();
                
                if (Object.keys(config).length === 0) {
                    showAlert('error', '⚠️ Arquivo .env não encontrado');
                    return;
                }
                
                // Campos de configuração rápida
                const quickFields = ['STRATEGY_TYPE', 'SYMBOL', 'GRID_LEVELS', 'ORDER_SIZE_USD', 'GRID_SPACING_PERCENT', 'MAX_POSITION_SIZE_USD'];
                
                quickFields.forEach(key => {
                    const input = document.getElementById(`config-${key}`);
                    if (input && config[key] !== undefined) {
                        input.value = config[key];
                    }
                });
                
                // Mostrar/ocultar opções de grid
                toggleStrategyOptions();
                
                // Configurações avançadas
                const advancedContainer = document.getElementById('advanced-config-container');
                const advancedFields = Object.entries(config).filter(([key]) => !quickFields.includes(key));
                
                if (advancedFields.length > 0) {
                    advancedContainer.innerHTML = advancedFields.map(([key, value]) => {
                        const isSecret = key.includes('PASSWORD') || key.includes('KEY') || key.includes('SECRET') || key === 'PRIVATE_KEY' || key === 'WALLET_ADDRESS';
                        return `
                            <div class="grid grid-cols-3 gap-4 items-center">
                                <label class="text-gray-400">${key}</label>
                                <input 
                                    type="${isSecret ? 'password' : 'text'}"
                                    id="config-advanced-${key}"
                                    value="${value}"
                                    class="col-span-2 bg-gray-700 text-white px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            </div>
                        `;
                    }).join('');
                } else {
                    advancedContainer.innerHTML = '<p class="text-gray-500">Nenhuma configuração avançada disponível</p>';
                }
                
                console.log('✅ Configurações carregadas');
            } catch (error) {
                console.error('Erro ao carregar config:', error);
                showAlert('error', 'Erro ao carregar configurações');
            }
        }
        
        async function saveConfig() {
            try {
                // Confirmar ação
                const botRunning = await isBotCurrentlyRunning();
                
                let confirmMessage = '💾 Salvar configurações?';
                if (botRunning) {
                    confirmMessage = '💾 Salvar e reiniciar o bot?\n\n⚠️ O bot está rodando e será reiniciado automaticamente para aplicar as novas configurações.';
                }
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                showAlert('info', '⏳ Salvando configurações...');
                
                // Coletar todas as configurações
                const response = await fetch(`${API_BASE}/api/config`);
                const config = await response.json();
                
                const updates = {};
                
                // Campos rápidos
                const quickFields = ['STRATEGY_TYPE', 'SYMBOL', 'GRID_LEVELS', 'ORDER_SIZE_USD', 'GRID_SPACING_PERCENT', 'MAX_POSITION_SIZE_USD'];
                quickFields.forEach(key => {
                    const input = document.getElementById(`config-${key}`);
                    if (input && input.value) {
                        updates[key] = input.value;
                    }
                });
                
                // Campos avançados
                for (const key of Object.keys(config)) {
                    const advInput = document.getElementById(`config-advanced-${key}`);
                    if (advInput) {
                        updates[key] = advInput.value;
                    }
                }
                
                // Salvar
                const saveResponse = await fetch(`${API_BASE}/api/config/update`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updates)
                });
                
                const result = await saveResponse.json();
                
                if (result.status !== 'success') {
                    showAlert('error', result.message);
                    return;
                }
                
                showAlert('success', '✅ Configurações salvas!');
                
                // Se bot está rodando, reiniciar automaticamente
                if (botRunning) {
                    showAlert('info', '🔄 Reiniciando bot...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const restartResult = await fetch(`${API_BASE}/api/bot/restart`, {
                        method: 'POST'
                    });
                    
                    const restartData = await restartResult.json();
                    
                    if (restartData.status === 'success') {
                        showAlert('success', '🎉 Bot reiniciado! Novas configurações aplicadas.');
                    } else {
                        showAlert('error', '❌ Erro ao reiniciar: ' + restartData.message);
                    }
                } else {
                    showAlert('info', 'ℹ️ Inicie o bot para aplicar as configurações.');
                }
                
            } catch (error) {
                console.error('Erro ao salvar config:', error);
                showAlert('error', 'Erro ao salvar configurações: ' + error.message);
            }
        }
        
        async function isBotCurrentlyRunning() {
            try {
                const response = await fetch(`${API_BASE}/api/bot/status`);
                const status = await response.json();
                return status.running === true;
            } catch (error) {
                return false;
            }
        }

        // ========== EXPORT ==========
        
        function exportCSV() {
            window.open(`${API_BASE}/api/export/csv`, '_blank');
            showAlert('success', '📥 Exportando CSV...');
        }

        // ========== VOLUME TRACKING ==========

        async function loadVolumeStats() {
            try {
                const response = await fetch(`${API_BASE}/api/volume/stats?periods=1h,24h,7d,14d`);
                const stats = await response.json();
                
                updateVolumeCards(stats);
                
                // Carregar detalhes de 24h
                if (stats['24h']) {
                    updateVolumeDetails(stats['24h']);
                }
                
            } catch (error) {
                console.error('Erro ao carregar volume:', error);
            }
        }

        function updateVolumeCards(stats) {
            const periods = ['1h', '24h', '7d', '14d'];
            
            periods.forEach(period => {
                const data = stats[period];
                if (!data) return;
                
                // Volume total
                const volumeEl = document.getElementById(`volume-${period}`);
                if (volumeEl) {
                    volumeEl.textContent = `$${formatNumber(data.total_volume)}`;
                }
                
                // Número de trades
                const tradesEl = document.getElementById(`volume-${period}-trades`);
                if (tradesEl) {
                    tradesEl.textContent = data.total_trades;
                }
                
                // Badge de variação (será preenchido pela comparação)
                const changeEl = document.getElementById(`volume-${period}-change`);
                if (changeEl) {
                    changeEl.textContent = '...';
                    changeEl.className = 'text-xs px-2 py-1 rounded bg-gray-700';
                }
            });
        }

        function updateVolumeDetails(data) {
            // Financeiro
            document.getElementById('volume-total-24h').textContent = `$${formatNumber(data.total_volume)}`;
            document.getElementById('volume-fees-24h').textContent = `$${formatNumber(data.total_fees)}`;
            
            const pnlEl = document.getElementById('volume-pnl-24h');
            pnlEl.textContent = `$${formatNumber(data.total_pnl)}`;
            pnlEl.className = data.total_pnl >= 0 ? 'font-bold text-green-400' : 'font-bold text-red-400';
            
            const avgVolume = data.total_trades > 0 ? data.total_volume / data.total_trades : 0;
            document.getElementById('volume-avg-24h').textContent = `$${formatNumber(avgVolume)}`;
            
            // Por símbolo
            const symbolContainer = document.getElementById('volume-by-symbol');
            if (data.by_symbol && Object.keys(data.by_symbol).length > 0) {
                symbolContainer.innerHTML = Object.entries(data.by_symbol)
                    .sort(([,a], [,b]) => b.volume - a.volume)
                    .map(([symbol, info]) => `
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-300">${symbol}:</span>
                            <div class="flex items-center gap-2">
                                <span class="font-bold">$${formatNumber(info.volume)}</span>
                                <span class="text-xs text-gray-500">(${info.trades})</span>
                            </div>
                        </div>
                    `).join('');
            } else {
                symbolContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhum trade encontrado</p>';
            }
            
            // Por direção
            if (data.by_side) {
                document.getElementById('volume-open-long').textContent = `$${formatNumber(data.by_side.open_long || 0)}`;
                document.getElementById('volume-open-short').textContent = `$${formatNumber(data.by_side.open_short || 0)}`;
                document.getElementById('volume-close-long').textContent = `$${formatNumber(data.by_side.close_long || 0)}`;
                document.getElementById('volume-close-short').textContent = `$${formatNumber(data.by_side.close_short || 0)}`;
            }
        }

        async function loadVolumeTimeline(hours = 24, interval = 60) {
            try {
                const response = await fetch(`${API_BASE}/api/volume/timeline?hours=${hours}&interval=${interval}`);
                const timeline = await response.json();
                
                if (!Array.isArray(timeline) || timeline.length === 0) {
                    console.warn('Timeline de volume vazia');
                    return;
                }
                
                updateVolumeTimelineChart(timeline);
                
            } catch (error) {
                console.error('Erro ao carregar timeline:', error);
            }
        }

        function updateVolumeTimelineChart(timeline) {
            const ctx = document.getElementById('volume-timeline-chart');
            if (!ctx) return;
            
            if (volumeTimelineChart) {
                volumeTimelineChart.destroy();
            }
            
            const labels = timeline.map(point => {
                const date = new Date(point.timestamp);
                return date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
            });
            
            const volumes = timeline.map(point => point.volume);
            
            volumeTimelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Volume (USD)',
                        data: volumes,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = timeline[context.dataIndex];
                                    return [
                                        `Volume: $${formatNumber(point.volume)}`,
                                        `Trades: ${point.trades}`,
                                        `PNL: $${formatNumber(point.pnl)}`
                                    ];
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { 
                                color: '#9ca3af',
                                maxTicksLimit: 12
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#9ca3af',
                                callback: value => `$${formatNumber(value)}`
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        async function loadVolumeComparison(period = '24h') {
            try {
                const response = await fetch(`${API_BASE}/api/volume/comparison?period=${period}`);
                const comparison = await response.json();
                
                updateVolumeComparison(comparison);
                
            } catch (error) {
                console.error('Erro ao carregar comparação:', error);
            }
        }

        function updateVolumeComparison(comparison) {
            // Período atual
            document.getElementById('comparison-current-volume').textContent = 
                `$${formatNumber(comparison.current.total_volume)}`;
            document.getElementById('comparison-current-trades').textContent = 
                comparison.current.total_trades;
            
            const currentPnlEl = document.getElementById('comparison-current-pnl');
            currentPnlEl.textContent = `$${formatNumber(comparison.current.total_pnl)}`;
            currentPnlEl.className = comparison.current.total_pnl >= 0 ? 
                'font-bold text-green-400' : 'font-bold text-red-400';
            
            // Período anterior
            document.getElementById('comparison-previous-volume').textContent = 
                `$${formatNumber(comparison.previous.total_volume)}`;
            document.getElementById('comparison-previous-trades').textContent = 
                comparison.previous.total_trades;
            
            const prevPnlEl = document.getElementById('comparison-previous-pnl');
            prevPnlEl.textContent = `$${formatNumber(comparison.previous.total_pnl)}`;
            prevPnlEl.className = comparison.previous.total_pnl >= 0 ? 
                'font-bold text-green-400' : 'font-bold text-red-400';
            
            // Variação
            document.getElementById('comparison-change-absolute').textContent = 
                `${comparison.change_absolute >= 0 ? '+' : ''}$${formatNumber(comparison.change_absolute)}`;
            
            const changePercentEl = document.getElementById('comparison-change-percent');
            changePercentEl.textContent = `${comparison.change_percent >= 0 ? '+' : ''}${comparison.change_percent.toFixed(1)}%`;
            
            if (comparison.change_percent >= 0) {
                changePercentEl.className = 'px-3 py-1 rounded font-bold bg-green-600 text-white';
            } else {
                changePercentEl.className = 'px-3 py-1 rounded font-bold bg-red-600 text-white';
            }
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num.toFixed(2);
        }

        // ========== INIT ==========
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('✅ DOM carregado');
            initWebSocket();
            showTab('dashboard');
            
            // Carregar dados iniciais
            loadPositionsAndOrders();
            updateRiskDashboard();
            
            
            // Polling periódico para dados (fallback se WebSocket falhar)
            setInterval(() => {
                loadPositionsAndOrders();
                if (currentTab === 'dashboard') {
                    updateRiskDashboard();
                    // loadRiskPositionsMonitor();
                }
            }, 30000); // A cada 30 segundos
        });
        
        // ========== RISK MANAGEMENT FUNCTIONS (MELHORADAS) ==========
        
        /**
         * ✅ MELHORADO: Carrega status de risco com tratamento robusto de erros
         */
        async function loadRiskStatus() {
            const container = document.getElementById('risk-status');
            
            // Mostrar loading
            container.innerHTML = `
                <div class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    <span class="ml-3 text-gray-400">Carregando dados de risco...</span>
                </div>
            `;
            
            try {
                console.log('📡 Buscando status de risco...');
                const response = await fetch(`${API_BASE}/api/risk/status`);
                
                // ✅ NOVO: Verificar status HTTP antes de parsear JSON
                if (!response.ok) {
                    console.warn(`⚠️ Resposta HTTP ${response.status} ao carregar risco`);
                    
                    // Tentar ler erro da resposta
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: `Erro HTTP ${response.status}` };
                    }
                    
                    console.warn('Dados de erro:', errorData);
                    
                    // ✅ NOVO: Mostrar UI de erro amigável baseada no status
                    const errorMessage = errorData.error || errorData.message || 'Serviço temporariamente indisponível';
                    const botStatus = errorData.bot_status || 'unknown';
                    
                    let statusIcon = '⚠️';
                    let statusColor = 'yellow';
                    let userMessage = errorMessage;
                    
                    if (response.status === 503) {
                        if (botStatus === 'disconnected') {
                            statusIcon = '🚫';
                            statusColor = 'red';
                            userMessage = 'Bot não está rodando. Inicie o bot para visualizar dados de risco em tempo real.';
                        } else if (botStatus === 'running_separate') {
                            statusIcon = '🔗';
                            statusColor = 'yellow';
                            userMessage = 'Bot rodando em processo separado. Dados de risco limitados neste modo.';
                        }
                    } else if (response.status === 500) {
                        statusIcon = '❌';
                        statusColor = 'red';
                        userMessage = 'Erro interno ao processar dados de risco. Verifique os logs.';
                    }
                    
                    container.innerHTML = `
                        <div class="bg-${statusColor}-900/30 border border-${statusColor}-600 rounded-lg p-6">
                            <div class="flex items-start gap-4">
                                <span class="text-4xl">${statusIcon}</span>
                                <div class="flex-1">
                                    <h3 class="text-xl font-semibold mb-2 text-${statusColor}-300">
                                        ${botStatus === 'disconnected' ? 'Bot Desconectado' : 
                                          botStatus === 'running_separate' ? 'Modo Limitado' : 
                                          'Erro ao Carregar'}
                                    </h3>
                                    <p class="text-gray-300 mb-3">${userMessage}</p>
                                    ${botStatus === 'disconnected' ? `
                                        <code class="block bg-gray-800 px-3 py-2 rounded text-sm mt-2">
                                            python grid_bot.py
                                        </code>
                                    ` : ''}
                                    ${response.status === 503 ? `
                                        <button onclick="loadRiskStatus()" 
                                                class="mt-3 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">
                                            🔄 Tentar Novamente
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // ✅ Resposta OK - parsear JSON
                const data = await response.json();
                console.log('✅ Status de risco carregado:', data);
                
                // ✅ NOVO: Validar estrutura básica do JSON
                if (!data || typeof data !== 'object') {
                    throw new Error('Resposta inválida do servidor');
                }
                
                // Atualizar display com dados
                updateRiskDisplay(data);
                
            } catch (error) {
                console.error('❌ Erro crítico ao carregar status de risco:', error);
                
                // ✅ NOVO: Mostrar erro detalhado para debugging
                container.innerHTML = `
                    <div class="bg-red-900/30 border border-red-600 rounded-lg p-6">
                        <div class="flex items-start gap-4">
                            <span class="text-4xl">❌</span>
                            <div class="flex-1">
                                <h3 class="text-xl font-semibold mb-2 text-red-300">Erro de Conexão</h3>
                                <p class="text-gray-300 mb-3">
                                    Não foi possível conectar ao servidor de risco.
                                </p>
                                <details class="text-sm">
                                    <summary class="cursor-pointer text-gray-400 hover:text-gray-300">
                                        Ver detalhes técnicos
                                    </summary>
                                    <pre class="mt-2 bg-gray-800 p-2 rounded overflow-x-auto text-xs">
${error.message}
${error.stack || ''}
                                    </pre>
                                </details>
                                <button onclick="loadRiskStatus()" 
                                        class="mt-3 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm">
                                    🔄 Tentar Novamente
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Mostrar alerta também
                showAlert('error', `Erro ao carregar dados de risco: ${error.message}`);
            }
        }
        
        function updateRiskDisplay(riskData) {
            const container = document.getElementById('risk-status');
            
            // Verificar se o bot não está rodando
            if (riskData.bot_status === 'disconnected') {
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="risk-metric bg-red-900/30 border border-red-700">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">🚫</span>
                                <div>
                                    <h4 class="font-semibold text-red-300">Bot Desconectado</h4>
                                    <p class="text-sm text-gray-400">Inicie o bot com: python grid_bot.py</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="risk-metric">
                            <h4 class="font-semibold mb-3">⚙️ Configurações (.env)</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Proteção de Sessão:</span>
                                    <span class="${riskData.session_protection ? 'text-green-400' : 'text-red-400'}">
                                        ${riskData.session_protection ? 'Ativada' : 'Desativada'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Limite de Perda:</span>
                                    <span class="text-red-400">$${riskData.session_max_loss_usd}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Meta de Lucro:</span>
                                    <span class="text-green-400">$${riskData.session_profit_target_usd}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="risk-metric">
                            <h4 class="font-semibold mb-3">🔄 Proteção de Ciclo</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Status:</span>
                                    <span class="${riskData.cycle_protection ? 'text-green-400' : 'text-red-400'}">
                                        ${riskData.cycle_protection ? 'Ativada' : 'Desativada'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Stop Loss:</span>
                                    <span class="text-red-400">${riskData.cycle_sl}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Take Profit:</span>
                                    <span class="text-green-400">${riskData.cycle_tp}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Bot rodando separadamente - mostrar configurações básicas
            if (riskData.bot_status === 'running_separate') {
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="risk-metric bg-yellow-900/30 border border-yellow-700">
                            <div class="flex items-center mb-3">
                                <span class="text-2xl mr-3">🔗</span>
                                <div>
                                    <h4 class="font-semibold text-yellow-300">Bot Rodando (Processo Separado)</h4>
                                    <p class="text-sm text-gray-400">Dados detalhados não disponíveis via Flask</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="risk-metric">
                            <h4 class="font-semibold mb-3">⚙️ Configurações Ativas</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Proteção de Sessão:</span>
                                    <span class="${riskData.session_protection ? 'text-green-400' : 'text-red-400'}">
                                        ${riskData.session_protection ? 'Ativada' : 'Desativada'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Limite de Perda:</span>
                                    <span class="text-red-400">$${riskData.session_max_loss_usd}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Meta de Lucro:</span>
                                    <span class="text-green-400">$${riskData.session_profit_target_usd}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="risk-metric">
                            <h4 class="font-semibold mb-3">🛡️ Sistema de Emergência</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Emergency SL:</span>
                                    <span class="text-red-400">${riskData.emergency_sl_percent}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Emergency TP:</span>
                                    <span class="text-green-400">${riskData.emergency_tp_percent}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Ação no Limite:</span>
                                    <span class="text-blue-400">${riskData.action_on_limit}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // ✅ CORREÇÃO: Verificar se temos dados completos ou apenas configurações básicas
            const hasComplexData = riskData.session_protection && 
                                   typeof riskData.session_protection === 'object' &&
                                   riskData.session_protection.loss_risk_level;
            
            if (!hasComplexData) {
                // Dados simples - mostrar apenas configurações básicas
                const botConnected = riskData.bot_status !== 'disconnected';
                const statusColor = botConnected ? (riskData.is_paused ? 'orange' : 'green') : 'orange';
                const statusIcon = botConnected ? (riskData.is_paused ? '⏸️' : '▶️') : '🔌';
                const statusText = riskData.is_paused ? `Pausado até: ${riskData.pause_until}` :
                                   botConnected ? 'Operando normalmente' : 'Aguardando conexão do bot...';
                
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Status Geral -->
                        <div class="bg-gray-700 rounded-lg p-4 border-l-4" style="border-left-color: ${statusColor};">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-300">Status Geral</h4>
                                <span class="text-2xl">${statusIcon}</span>
                            </div>
                            <div class="text-lg font-bold" style="color: ${statusColor};">${statusText}</div>
                            ${riskData.last_check ? `<div class="text-xs text-gray-400 mt-2">Última verificação: ${riskData.last_check}</div>` : ''}
                        </div>
                        
                        <!-- Nível 1 (Ciclo) -->
                        <div class="bg-gray-700 rounded-lg p-4 border-l-4 ${riskData.cycle_protection ? 'border-green-500' : 'border-red-500'}">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-300">🔄 Nível 1 (Ciclo)</h4>
                                <span class="${riskData.cycle_protection ? 'text-green-400' : 'text-red-400'} text-sm font-medium">
                                    ${riskData.cycle_protection ? '✅ Ativo' : '❌ Desligado'}
                                </span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Stop Loss:</span>
                                    <span class="text-red-400 font-medium">${riskData.cycle_sl}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Take Profit:</span>
                                    <span class="text-green-400 font-medium">${riskData.cycle_tp}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Nível 2 (Sessão) -->
                        <div class="bg-gray-700 rounded-lg p-4 border-l-4 ${riskData.session_protection ? 'border-green-500' : 'border-red-500'}">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-300">🛡️ Nível 2 (Sessão)</h4>
                                <span class="${riskData.session_protection ? 'text-green-400' : 'text-red-400'} text-sm font-medium">
                                    ${riskData.session_protection ? '✅ Ativo' : '❌ Desligado'}
                                </span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Max Loss:</span>
                                    <span class="text-red-400 font-medium">$${riskData.session_max_loss_usd}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Meta Lucro:</span>
                                    <span class="text-green-400 font-medium">$${riskData.session_profit_target_usd}</span>
                                </div>
                                ${riskData.action_on_limit ? `
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ação:</span>
                                    <span class="text-blue-400 font-medium">${riskData.action_on_limit}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Emergency Stop -->
                        <div class="bg-gray-700 rounded-lg p-4 border-l-4 border-orange-500">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-300">🚨 Emergency Stop</h4>
                                <span class="text-orange-400 text-xs px-2 py-1 bg-orange-900 rounded">BACKUP</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Emergency SL:</span>
                                    <span class="text-red-400 font-medium">${riskData.emergency_sl_percent}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Emergency TP:</span>
                                    <span class="text-green-400 font-medium">${riskData.emergency_tp_percent}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Posições Ativas -->
                        <div class="bg-gray-700 rounded-lg p-4 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-300">📊 Posições Ativas</h4>
                                <span class="text-2xl font-bold text-blue-400">${riskData.active_positions_count || 0}</span>
                            </div>
                            <div class="text-xs text-gray-400">
                                ${(riskData.active_positions_count || 0) > 0 ? 'Posições abertas no momento' : 'Nenhuma posição aberta'}
                            </div>
                        </div>
                        
                        <!-- Desempenho -->
                        <div class="bg-gray-700 rounded-lg p-4 border-l-4 ${(riskData.accumulated_pnl || 0) >= 0 ? 'border-green-500' : 'border-red-500'}">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-300">💰 Desempenho</h4>
                                <span class="${(riskData.accumulated_pnl || 0) >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">
                                    ${(riskData.accumulated_pnl || 0) >= 0 ? '+' : ''}${(riskData.accumulated_pnl || 0).toFixed(2)} USD
                                </span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Ciclos:</span>
                                    <span class="text-gray-300">${riskData.cycles_closed || 0}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">🏆 Lucro:</span>
                                    <span class="text-green-400">${riskData.cycles_profit || 0}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">💀 Perda:</span>
                                    <span class="text-red-400">${riskData.cycles_loss || 0}</span>
                                </div>
                                ${riskData.session_start && riskData.session_start !== 'Bot não iniciado' ? `
                                    <div class="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-600">
                                        Início: ${riskData.session_start}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Dados completos - usar a estrutura complexa original
            const session = riskData.session_protection;
            const cycle = riskData.cycle_protection;
            
            // Determinar status geral
            let overallStatus = 'safe';
            if (session.loss_risk_level === 'HIGH' || cycle.loss_risk_level === 'HIGH') {
                overallStatus = 'danger';
            } else if (session.loss_risk_level === 'MEDIUM' || cycle.loss_risk_level === 'MEDIUM') {
                overallStatus = 'warning';
            }
            
            container.innerHTML = `
                <div class="risk-metrics">
                    <!-- Status Geral -->
                    <div class="risk-metric risk-status-${overallStatus}">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium">Status Geral</span>
                            <span class="text-lg">${overallStatus === 'safe' ? '🟢' : overallStatus === 'warning' ? '🟡' : '🔴'}</span>
                        </div>
                        <p class="text-xl font-bold">
                            ${overallStatus === 'safe' ? 'Seguro' : overallStatus === 'warning' ? 'Atenção' : 'Risco Alto'}
                        </p>
                    </div>
                    
                    <!-- Sessão -->
                    <div class="risk-metric">
                        <h4 class="font-semibold mb-3">📊 Sessão Atual</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>PNL Atual:</span>
                                <span class="${session.current_pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    $${session.current_pnl.toFixed(2)}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Meta Lucro:</span>
                                <span class="text-green-400">$${session.profit_target.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Limite Perda:</span>
                                <span class="text-red-400">-$${session.max_loss.toFixed(2)}</span>
                            </div>
                            <div class="mt-3">
                                <div class="flex justify-between mb-1">
                                    <span>Margem de Segurança:</span>
                                    <span class="text-${session.loss_risk_level === 'LOW' ? 'green' : session.loss_risk_level === 'MEDIUM' ? 'yellow' : 'red'}-400">
                                        $${session.remaining_loss_buffer.toFixed(2)}
                                    </span>
                                </div>
                                <div class="risk-progress">
                                    <div class="risk-progress-bar risk-progress-${session.loss_risk_level === 'LOW' ? 'safe' : session.loss_risk_level === 'MEDIUM' ? 'warning' : 'danger'}" 
                                         style="width: ${Math.max(0, Math.min(100, (session.max_loss + session.current_pnl) / session.max_loss * 100))}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ciclo -->
                    <div class="risk-metric">
                        <h4 class="font-semibold mb-3">🔄 Ciclo Atual</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>PNL Ciclo:</span>
                                <span class="${cycle.current_pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    $${cycle.current_pnl.toFixed(2)}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Meta Lucro:</span>
                                <span class="text-green-400">$${cycle.profit_target.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Limite Perda:</span>
                                <span class="text-red-400">-$${cycle.max_loss.toFixed(2)}</span>
                            </div>
                            <div class="mt-3">
                                <div class="flex justify-between mb-1">
                                    <span>Margem de Segurança:</span>
                                    <span class="text-${cycle.loss_risk_level === 'LOW' ? 'green' : cycle.loss_risk_level === 'MEDIUM' ? 'yellow' : 'red'}-400">
                                        $${cycle.remaining_loss_buffer.toFixed(2)}
                                    </span>
                                </div>
                                <div class="risk-progress">
                                    <div class="risk-progress-bar risk-progress-${cycle.loss_risk_level === 'LOW' ? 'safe' : cycle.loss_risk_level === 'MEDIUM' ? 'warning' : 'danger'}" 
                                         style="width: ${Math.max(0, Math.min(100, (cycle.max_loss + cycle.current_pnl) / cycle.max_loss * 100))}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Emergency Stop -->
                    ${riskData.emergency_stop ? `
                    <div class="risk-metric risk-status-${riskData.emergency_stop.is_active ? 'danger' : 'safe'}">
                        <h4 class="font-semibold mb-3">🚨 Emergency Stop</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Status:</span>
                                <span class="${riskData.emergency_stop.is_active ? 'text-red-400' : 'text-green-400'}">
                                    ${riskData.emergency_stop.is_active ? 'ATIVO' : 'Desativo'}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span>Limite:</span>
                                <span class="text-red-400">-$${riskData.emergency_stop.stop_loss_threshold.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        // ========== RISK MONITOR FUNCTIONS ==========
        
        /**
         * ✅ MELHORADO: Carrega monitor de posições com tratamento robusto
         */
        async function loadRiskPositionsMonitor() {
            const container = document.getElementById('risk-positions-container');
            const statusContainer = document.getElementById('risk-monitor-status');
            
            // Mostrar loading
            container.innerHTML = `
                <div class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    <span class="ml-3 text-gray-400">Carregando posições...</span>
                </div>
            `;
            
            try {
                console.log('📡 Buscando posições para risk monitor...');
                const response = await fetch(`${API_BASE}/api/risk/positions`);
                
                // ✅ NOVO: Verificar status antes de parsear
                if (!response.ok) {
                    console.warn(`⚠️ Resposta HTTP ${response.status}`);
                    
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: `Erro HTTP ${response.status}` };
                    }
                    
                    updateRiskMonitorStatus('error');
                    
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">⚠️</div>
                            <h3 class="text-xl font-semibold mb-2 text-yellow-300">Erro ao Carregar Posições</h3>
                            <p class="text-gray-400 mb-4">${errorData.error || 'Serviço indisponível'}</p>
                            <button onclick="loadRiskPositionsMonitor()" 
                                    class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                                🔄 Tentar Novamente
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const data = await response.json();
                console.log('✅ Posições carregadas:', data);
                
                // ✅ NOVO: Validar estrutura
                if (!data || typeof data !== 'object') {
                    throw new Error('Resposta inválida do servidor');
                }
                
                updateRiskPositionsDisplay(data);
                updateRiskMonitorStatus(data.bot_status || 'unknown');
                
            } catch (error) {
                console.error('❌ Erro ao carregar risk monitor:', error);
                
                updateRiskMonitorStatus('error');
                
                container.innerHTML = `
                    <div class="bg-red-900/30 border border-red-600 rounded-lg p-6 text-center">
                        <div class="text-4xl mb-4">❌</div>
                        <h3 class="text-xl font-semibold mb-2 text-red-300">Erro de Conexão</h3>
                        <p class="text-gray-400 mb-4">${error.message}</p>
                        <button onclick="loadRiskPositionsMonitor()" 
                                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                            🔄 Tentar Novamente
                        </button>
                    </div>
                `;
                
                showAlert('error', `Erro ao carregar monitor: ${error.message}`);
            }
        }
        
        /**
         * ✅ MELHORADO: Atualiza status do monitor com ícones corretos
         */
        function updateRiskMonitorStatus(status) {
            const statusContainer = document.getElementById('risk-monitor-status');
            if (!statusContainer) return;
            
            const indicator = statusContainer.querySelector('.w-3');
            const text = statusContainer.querySelector('span');
            
            if (!indicator || !text) return;
            
            // ✅ NOVO: Mapeamento de status mais completo
            const statusMap = {
                'connected': {
                    color: 'bg-green-500',
                    text: 'Conectado',
                    class: 'monitor-status-connected'
                },
                'running_separate': {
                    color: 'bg-yellow-500',
                    text: 'Bot Separado',
                    class: 'monitor-status-warning'
                },
                'disconnected': {
                    color: 'bg-red-500',
                    text: 'Desconectado',
                    class: 'monitor-status-disconnected'
                },
                'error': {
                    color: 'bg-red-500',
                    text: 'Erro',
                    class: 'monitor-status-disconnected'
                },
                'unknown': {
                    color: 'bg-gray-500',
                    text: 'Desconhecido',
                    class: 'text-gray-400'
                }
            };
            
            const config = statusMap[status] || statusMap['unknown'];
            
            indicator.className = `w-3 h-3 rounded-full ${config.color}`;
            text.textContent = config.text;
            text.className = `text-sm ${config.class}`;
        }
        
        /**
         * ✅ MELHORADO: Refresh manual do risk monitor
         */
        function refreshRiskMonitor() {
            console.log('🔄 Refresh manual do risk monitor');
           // loadRiskPositionsMonitor();
        }
        
        /**
         * ✅ NOVO: Função helper para mostrar placeholders de loading
         */
        function showRiskLoadingPlaceholder(containerId, message = 'Carregando...') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = `
                <div class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    <span class="ml-3 text-gray-400">${message}</span>
                </div>
            `;
        }
        
        /**
         * ✅ NOVO: Função helper para validar resposta JSON
         */
        function validateRiskResponse(data, requiredFields = []) {
            if (!data || typeof data !== 'object') {
                console.error('❌ Resposta inválida:', data);
                return false;
            }
            
            for (const field of requiredFields) {
                if (!(field in data)) {
                    console.warn(`⚠️ Campo obrigatório ausente: ${field}`);
                    // Não retorna false - campos ausentes terão valores padrão
                }
            }
            
            return true;
        }
        
        // ========== FIM DAS CORREÇÕES RISK MANAGEMENT ==========
        console.log('✅ Funções de Risk Management corrigidas e carregadas (v1.2)');

        // ========== PAINEL UNIFICADO DE RISCO - TELEMETRIA ==========
        
        async function fetchJson(path) {
          const res = await fetch(path);
          if (!res.ok) throw new Error(`Falha ao buscar ${path}`);
          return await res.json();
        }

        function fmtNum(v, digits = 2) {
          return isNaN(v) ? '—' : parseFloat(v).toFixed(digits);
        }

        function fmtTime(secs) {
          if (!secs) return '—';
          const h = Math.floor(secs / 3600);
          const m = Math.floor((secs % 3600) / 60);
          const s = secs % 60;
          return `${h}h ${m}m ${s}s`;
        }

        async function updateRiskDashboard() {
          try {
            const [active, status] = await Promise.all([
              fetchJson('/api/risk/telemetry/active'),
              fetchJson('/api/risk/telemetry/status')
            ]);

            // 🔹 CONFIGURAÇÕES
            const trade = active.trade || active || {};
            const extra = trade.extra || {};
            const emerg = extra.emergency || {};
            const session = extra.session || {};
            const risk_config = extra.risk_config || {};

            document.getElementById('cfg-cycle-sl').textContent = extra.cycle_thresholds?.['sl%'] ?? '—';
            document.getElementById('cfg-cycle-tp').textContent = extra.cycle_thresholds?.['tp%'] ?? '—';
            document.getElementById('cfg-emerg-sl').textContent = risk_config.emergency_sl_percent ?? emerg['sl%'] ?? '—';
            document.getElementById('cfg-emerg-tp').textContent = risk_config.emergency_tp_percent ?? emerg['tp%'] ?? '—';
            document.getElementById('cfg-margin').textContent = status.margin_percent ?? '—';
            document.getElementById('cfg-session-loss').textContent = risk_config.session_max_loss_usd ?? session.max_loss_usd ?? '—';
            document.getElementById('cfg-session-profit').textContent = risk_config.session_profit_target_usd ?? session.profit_target_usd ?? '—';

            // 🔹 TRADE ATUAL
            const pnlUsd = trade.pnl_usd ?? 0;
            const pnlPct = trade.pnl_percent ?? 0;
            const pnlColor = pnlUsd > 0 ? '#4ade80' : pnlUsd < 0 ? '#f87171' : '#e5e7eb';
            document.getElementById('trade-id').textContent = trade.trade_id || '—';
            document.getElementById('trade-symbol').textContent = trade.symbol || '—';
            document.getElementById('trade-side').textContent = trade.side || '—';
            document.getElementById('trade-time').textContent = fmtTime(trade.time_in_trade_sec);
            document.getElementById('trade-price').textContent = fmtNum(trade.current_price);
            document.getElementById('trade-pnl-usd').textContent = `$${fmtNum(pnlUsd)}`;
            document.getElementById('trade-pnl-usd').style.color = pnlColor;
            document.getElementById('trade-pnl-pct').textContent = `${fmtNum(pnlPct)}%`;
            document.getElementById('trade-pnl-pct').style.color = pnlColor;
            document.getElementById('trade-status').textContent = active.active ? 'Trade em andamento' : 'Nenhum trade ativo';

            // 🔹 SESSÃO / SAÚDE
            document.getElementById('session-cycles').textContent = session.cycles_closed ?? '0';
            document.getElementById('session-pnl').textContent = fmtNum(session.accumulated_pnl ?? 0);
            document.getElementById('session-margin').textContent = fmtNum(status.margin_percent ?? 0);
            document.getElementById('session-lastcheck').textContent = new Date(status.timestamp || Date.now()).toLocaleTimeString();
            document.getElementById('session-flags').textContent = Object.keys(extra).length ? Object.keys(extra).join(', ') : '—';

            // Indicador geral
            const ind = document.getElementById('risk-status-indicator');
            const isActive = active.active === true || active.active === "true" || (active.trade && Object.keys(active.trade).length > 0);
            ind.textContent = isActive ? 'Online' : 'Parado';
            ind.style.backgroundColor = isActive ? '#22c55e' : '#ef4444';
          } catch (err) {
            console.warn('Erro atualizando painel de risco', err);
          }
        }

        // Inicializar painel de risco unificado
        setInterval(updateRiskDashboard, 3000);
        updateRiskDashboard();
        console.log('✅ Painel unificado de risco inicializado');
        
        function updateRiskPositionsDisplay(data) {
            const container = document.getElementById('risk-positions-container');
            
            if (data.bot_status === 'disconnected') {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">🚫</div>
                        <h3 class="text-xl font-semibold mb-2 text-red-300">Bot Não Está Rodando</h3>
                        <p class="text-gray-400 mb-4">Inicie o bot para monitorar posições em tempo real</p>
                        <code class="bg-gray-800 px-3 py-1 rounded text-sm">python grid_bot.py</code>
                    </div>
                `;
                return;
            }
            
            if (data.bot_status === 'running_separate') {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">🔗</div>
                        <h3 class="text-xl font-semibold mb-2 text-yellow-300">Bot Rodando (Processo Separado)</h3>
                        <p class="text-gray-400 mb-4">Risk managers não integrados ao Flask</p>
                        <p class="text-sm text-gray-500">Dados de monitoramento limitados neste modo</p>
                    </div>
                `;
                return;
            }
            
            if (!data.positions || data.positions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">📊</div>
                        <h3 class="text-xl font-semibold mb-2">Nenhuma Posição Ativa</h3>
                        <p class="text-gray-400">O bot está rodando mas não há posições para monitorar</p>
                    </div>
                `;
                return;
            }
            
            // Renderizar posições
            container.innerHTML = data.positions.map(position => createPositionCard(position)).join('');
        }
        
        /**
         * ✅ MELHORADO: Cria card de posição com validação robusta
         */
        function createPositionCard(position) {
            // ✅ NOVO: Validação de segurança robusta
            if (!position || typeof position !== 'object') {
                console.error('❌ createPositionCard recebeu dados inválidos:', position);
                return `
                    <div class="position-card bg-red-900/30 border border-red-600 rounded-lg p-4 text-center">
                        <p class="text-red-400">❌ Erro: Dados da posição inválidos</p>
                    </div>
                `;
            }
            
            // ✅ NOVO: Valores padrão seguros com validação de tipo
            const safeFloat = (value, defaultValue = 0) => {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? defaultValue : parsed;
            };
            
            const safeString = (value, defaultValue = 'N/A') => {
                return value && typeof value === 'string' ? value : defaultValue;
            };
            
            // Extrair dados com valores padrão
            const symbol = safeString(position.symbol, 'UNKNOWN');
            const side = safeString(position.side, 'unknown');
            const quantity = safeFloat(position.quantity, 0);
            const entryPrice = safeFloat(position.entry_price, 0);
            const currentPrice = safeFloat(position.current_price, 0);
            const pnlUsd = safeFloat(position.pnl_usd, 0);
            const pnlPercent = safeFloat(position.pnl_percent, 0);
            const leverage = safeFloat(position.leverage, 1);
            
            // Determinar classes de estilo
            const pnlClass = pnlUsd > 0 ? 'positive' : pnlUsd < 0 ? 'negative' : 'neutral';
            const riskLevel = position.overall_risk_level || 1;
            
            // ✅ NOVO: Validar estruturas aninhadas antes de usar
            const hasCycleProtection = position.cycle_protection && 
                                       typeof position.cycle_protection === 'object';
            
            const hasSessionProtection = position.session_protection && 
                                         typeof position.session_protection === 'object';
            
            const hasEmergencySystem = position.emergency_system && 
                                      typeof position.emergency_system === 'object';
            
            // Helper para criar item de risco com validação
            const createRiskItemSafe = (label, data, type = 'percent') => {
                if (!data || typeof data !== 'object') {
                    return `
                        <div class="risk-item-placeholder">
                            ${label}: Não configurado
                        </div>
                    `;
                }
                
                const current = safeFloat(data.current_percent || data.current, 0);
                const limit = safeFloat(data.limit_percent || data.limit || data.target_percent, 0);
                const status = safeString(data.status, 'unknown');
                const triggered = data.triggered === true;
                
                const progress = limit !== 0 ? Math.min(100, Math.abs(current / limit) * 100) : 0;
                const statusClass = triggered ? 'critical' : status;
                
                return `
                    <div class="risk-item">
                        <div class="risk-item-label">
                            <div class="risk-status-indicator status-${statusClass}"></div>
                            <span>${label}</span>
                        </div>
                        <div class="risk-item-value ${triggered ? 'text-red-400 font-bold' : ''}">
                            ${current.toFixed(2)}${type} / ${Math.abs(limit).toFixed(2)}${type}
                            ${triggered ? ' ⚠️' : ''}
                        </div>
                    </div>
                    <div class="risk-progress-container">
                        <div class="risk-progress-label">
                            <span>${label}</span>
                            <span>${progress.toFixed(1)}%</span>
                        </div>
                        <div class="risk-progress-bar-container">
                            <div class="risk-progress-fill risk-progress-${statusClass}" 
                                 style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            };
            
            return `
                <div class="position-card risk-level-${riskLevel}">
                    <div class="position-header">
                        <div>
                            <div class="position-symbol">
                                ${symbol} 
                                <span class="text-sm font-normal text-gray-400">
                                    ${side.toUpperCase()} ${quantity.toFixed(4)}
                                </span>
                            </div>
                            <div class="text-sm text-gray-400">
                                Entry: $${entryPrice.toLocaleString()} | 
                                Current: $${currentPrice.toLocaleString()}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="position-pnl ${pnlClass}">
                                ${pnlUsd >= 0 ? '+' : ''}$${pnlUsd.toFixed(2)}
                            </div>
                            <div class="position-pnl ${pnlClass} text-sm">
                                ${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="risk-layers">
                        <!-- Nível 1: Proteção por Ciclo -->
                        <div class="risk-layer">
                            <div class="risk-layer-header">
                                <span>🛡️ Nível 1 - Proteção por Ciclo</span>
                            </div>
                            <div class="risk-items">
                                ${hasCycleProtection && position.cycle_protection.stop_loss ? 
                                    createRiskItemSafe('Stop Loss', position.cycle_protection.stop_loss, '%') :
                                    '<div class="risk-item-placeholder">Stop Loss: Não configurado</div>'
                                }
                                ${hasCycleProtection && position.cycle_protection.take_profit ? 
                                    createRiskItemSafe('Take Profit', position.cycle_protection.take_profit, '%') :
                                    '<div class="risk-item-placeholder">Take Profit: Não configurado</div>'
                                }
                            </div>
                        </div>
                        
                        <!-- Nível 2: Proteção de Sessão -->
                        <div class="risk-layer">
                            <div class="risk-layer-header">
                                <span>📊 Nível 2 - Proteção de Sessão</span>
                            </div>
                            <div class="risk-items">
                                ${hasSessionProtection ? `
                                    <div class="risk-item">
                                        <div class="risk-item-label">
                                            <span>PNL Sessão</span>
                                        </div>
                                        <div class="risk-item-value ${position.session_protection.current_session_pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                                            ${position.session_protection.current_session_pnl >= 0 ? '+' : ''}$${safeFloat(position.session_protection.current_session_pnl).toFixed(2)}
                                        </div>
                                    </div>
                                    <div class="risk-item">
                                        <div class="risk-item-label">
                                            <span>Margem de Segurança</span>
                                        </div>
                                        <div class="risk-item-value">
                                            $${safeFloat(position.session_protection.remaining_loss_buffer).toFixed(2)}
                                        </div>
                                    </div>
                                ` : '<div class="risk-item-placeholder">Proteção de Sessão: Não configurada</div>'}
                            </div>
                        </div>
                        
                        <!-- Nível 3: Emergency System -->
                        <div class="risk-layer">
                            <div class="risk-layer-header">
                                <span>🚨 Nível 3 - Sistema de Emergência</span>
                            </div>
                            <div class="risk-items">
                                ${hasEmergencySystem && position.emergency_system.emergency_sl ? 
                                    createRiskItemSafe('Emergency SL', position.emergency_system.emergency_sl, '%') :
                                    '<div class="risk-item-placeholder">Emergency SL: Não configurado</div>'
                                }
                                ${hasEmergencySystem && position.emergency_system.time_monitoring ? `
                                    <div class="risk-item">
                                        <div class="risk-item-label">
                                            <div class="risk-status-indicator status-${safeString(position.emergency_system.time_monitoring.status)}"></div>
                                            <span>Tempo em Loss</span>
                                        </div>
                                        <div class="risk-item-value">
                                            ${safeFloat(position.emergency_system.time_monitoring.time_in_loss_minutes)}min / 
                                            ${safeFloat(position.emergency_system.time_monitoring.max_time_minutes)}min
                                        </div>
                                    </div>
                                ` : '<div class="risk-item-placeholder">Monitoramento de Tempo: Não configurado</div>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ========== CSV ANALYSIS VARIABLES ==========
        let csvWinrateChart = null;
        let csvCumulativePNLChart = null;
        let currentAnalysis = null;
        
        // ========== CSV UPLOAD FUNCTIONS ==========
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showAlert('error', '❌ Arquivo deve ser CSV');
                return;
            }
            
            await uploadAndAnalyzeCSV(file);
        }
        
        async function uploadAndAnalyzeCSV(file) {
            const progressDiv = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const statusText = document.getElementById('upload-status');
            
            try {
                progressDiv.classList.remove('hidden');
                progressBar.style.width = '10%';
                statusText.textContent = 'Enviando arquivo...';
                
                const formData = new FormData();
                formData.append('file', file);
                
                progressBar.style.width = '40%';
                
                const response = await fetch(`${API_BASE}/api/csv/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                progressBar.style.width = '70%';
                statusText.textContent = 'Processando CSV...';
                
                const result = await response.json();
                
                progressBar.style.width = '100%';
                
                if (result.status === 'success') {
                    showAlert('success', `✅ ${result.message}`);
                    
                    // Mostrar resultados
                    displayAnalysis(result.stats);
                    
                    // Atualizar lista de arquivos
                    await refreshCSVList();
                    
                    setTimeout(() => {
                        progressDiv.classList.add('hidden');
                        progressBar.style.width = '0%';
                    }, 2000);
                } else {
                    showAlert('error', `❌ ${result.message}`);
                    progressDiv.classList.add('hidden');
                }
                
                // Limpar input
                document.getElementById('csv-file-input').value = '';
                
            } catch (error) {
                console.error('Erro no upload:', error);
                showAlert('error', '❌ Erro ao processar arquivo');
                progressDiv.classList.add('hidden');
            }
        }
        
        // ========== CSV FILE LIST ==========
        
        async function refreshCSVList() {
            try {
                const response = await fetch(`${API_BASE}/api/csv/list`);
                const result = await response.json();
                
                const container = document.getElementById('csv-files-list');
                
                if (result.status === 'success' && result.files.length > 0) {
                    container.innerHTML = result.files.map(file => {
                        const date = new Date(file.modified).toLocaleString('pt-BR');
                        const size = (file.size / 1024).toFixed(1);
                        
                        return `
                            <div class="flex items-center justify-between bg-gray-700 rounded p-3 hover:bg-gray-600">
                                <div class="flex-1">
                                    <p class="font-semibold">${file.filename}</p>
                                    <p class="text-sm text-gray-400">${size} KB - ${date}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="analyzeCSVFile('${file.filename}')" 
                                            class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                                        📊 Analisar
                                    </button>
                                    <button onclick="deleteCSVFile('${file.filename}')" 
                                            class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-500">Nenhum arquivo CSV encontrado. Faça upload de um CSV da Pacifica.</p>';
                }
            } catch (error) {
                console.error('Erro ao listar CSVs:', error);
            }
        }
        
        async function analyzeCSVFile(filename) {
            try {
                showAlert('info', `📊 Analisando ${filename}...`);
                
                const response = await fetch(`${API_BASE}/api/csv/analyze/${encodeURIComponent(filename)}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayAnalysis(result.data);
                    showAlert('success', '✅ Análise concluída!');
                } else {
                    showAlert('error', `❌ ${result.message}`);
                }
            } catch (error) {
                console.error('Erro ao analisar:', error);
                showAlert('error', '❌ Erro ao analisar arquivo');
            }
        }
        
        async function deleteCSVFile(filename) {
            if (!confirm(`Tem certeza que deseja deletar ${filename}?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/csv/delete/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showAlert('success', '✅ Arquivo deletado');
                    await refreshCSVList();
                } else {
                    showAlert('error', `❌ ${result.message}`);
                }
            } catch (error) {
                console.error('Erro ao deletar:', error);
                showAlert('error', '❌ Erro ao deletar arquivo');
            }
        }
        
        // ========== DISPLAY ANALYSIS ==========
        
        function displayAnalysis(stats) {
            currentAnalysis = stats;
            const summary = stats.summary;
            
            // Show results section
            document.getElementById('csv-analysis-results').classList.remove('hidden');
            
            // Update summary cards
            document.getElementById('csv-total-trades').textContent = summary.total_trades;
            document.getElementById('csv-win-rate').textContent = `${summary.win_rate}%`;
            document.getElementById('csv-total-pnl').textContent = `$${summary.total_pnl.toFixed(2)}`;
            document.getElementById('csv-total-pnl').className = `text-3xl font-bold ${summary.total_pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('csv-profit-factor').textContent = summary.profit_factor.toFixed(2);
            
            // Update detailed stats
            document.getElementById('csv-winning-trades').textContent = summary.winning_trades;
            document.getElementById('csv-losing-trades').textContent = summary.losing_trades;
            document.getElementById('csv-avg-trade').textContent = `$${summary.avg_trade.toFixed(2)}`;
            document.getElementById('csv-avg-trade').className = `font-bold ${summary.avg_trade >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('csv-avg-win').textContent = `$${summary.avg_win.toFixed(2)}`;
            document.getElementById('csv-avg-loss').textContent = `$${summary.avg_loss.toFixed(2)}`;
            
            // Financial
            document.getElementById('csv-total-volume').textContent = `$${summary.total_volume.toFixed(2)}`;
            document.getElementById('csv-total-fees').textContent = `$${summary.total_fees.toFixed(2)}`;
            document.getElementById('csv-net-profit').textContent = `$${summary.net_profit.toFixed(2)}`;
            document.getElementById('csv-net-profit').className = `font-bold ${summary.net_profit >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            if (summary.best_trade) {
                document.getElementById('csv-best-trade').textContent = `$${summary.best_trade.pnl.toFixed(2)}`;
            }
            
            if (summary.worst_trade) {
                document.getElementById('csv-worst-trade').textContent = `$${summary.worst_trade.pnl.toFixed(2)}`;
            }
            
            // Update charts
            updateCSVCharts(stats);
            
            // Update tables
            updateSymbolTable(stats.by_symbol);
            updateDailyTable(stats.daily);
        }
        
        // ========== CSV CHARTS ==========
        
        function updateCSVCharts(stats) {
            const summary = stats.summary;
            
            // Win Rate Chart
            if (csvWinrateChart) {
                csvWinrateChart.destroy();
            }
            
            const ctx1 = document.getElementById('csv-winrate-chart').getContext('2d');
            csvWinrateChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Ganhos', 'Perdas', 'Breakeven'],
                    datasets: [{
                        data: [
                            summary.winning_trades, 
                            summary.losing_trades,
                            summary.breakeven_trades
                        ],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(156, 163, 175, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
            
            // Cumulative PNL Chart
            if (csvCumulativePNLChart) {
                csvCumulativePNLChart.destroy();
            }
            
            // Calculate cumulative PNL from raw trades
            const trades = stats.raw_trades || [];
            const cumulativeData = [];
            let cumulative = 0;
            
            trades.forEach(trade => {
                cumulative += trade.net_pnl;
                cumulativeData.push(cumulative);
            });
            
            const ctx2 = document.getElementById('csv-cumulative-pnl-chart').getContext('2d');
            csvCumulativePNLChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: trades.map((_, i) => `Trade ${i + 1}`),
                    datasets: [{
                        label: 'PNL Acumulado',
                        data: cumulativeData,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#9ca3af',
                                maxTicksLimit: 10
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#9ca3af',
                                callback: value => `$${value.toFixed(2)}`
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }
        
        // ========== TABLES ==========
        
        function updateSymbolTable(bySymbol) {
            const tbody = document.getElementById('csv-symbol-tbody');
            
            if (!bySymbol || Object.keys(bySymbol).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Nenhum dado disponível</td></tr>';
                return;
            }
            
            tbody.innerHTML = Object.entries(bySymbol)
                .sort(([,a], [,b]) => b.pnl - a.pnl)
                .map(([symbol, data]) => `
                    <tr class="border-b border-gray-700">
                        <td class="py-3 font-semibold">${symbol}</td>
                        <td class="py-3">${data.trades}</td>
                        <td class="py-3">${data.win_rate}%</td>
                        <td class="py-3 ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                            $${data.pnl.toFixed(2)}
                        </td>
                        <td class="py-3 text-red-400">$${data.fees.toFixed(2)}</td>
                        <td class="py-3">$${data.volume.toFixed(2)}</td>
                    </tr>
                `).join('');
        }
        
        function updateDailyTable(daily) {
            const tbody = document.getElementById('csv-daily-tbody');
            
            if (!daily || Object.keys(daily).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhum dado disponível</td></tr>';
                return;
            }
            
            tbody.innerHTML = Object.entries(daily)
                .sort(([a], [b]) => b.localeCompare(a))
                .map(([date, data]) => `
                    <tr class="border-b border-gray-700">
                        <td class="py-3">${date}</td>
                        <td class="py-3">${data.trades}</td>
                        <td class="py-3">${data.win_rate}%</td>
                        <td class="py-3 ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                            $${data.pnl.toFixed(2)}
                        </td>
                        <td class="py-3">$${data.volume.toFixed(2)}</td>
                    </tr>
                `).join('');
        }
        
        // ========== INIT CSV TAB ==========
        
        async function loadLastAnalysis() {
            try {
                const response = await fetch(`${API_BASE}/api/csv/analysis`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    displayAnalysis(result.data);
                }
            } catch (error) {
                console.log('Nenhuma análise anterior disponível');
            }
        }
        
        // Drag and drop support
        const csvTab = document.getElementById('content-csv-analysis');
        if (csvTab) {
            csvTab.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            csvTab.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.toLowerCase().endsWith('.csv')) {
                    await uploadAndAnalyzeCSV(files[0]);
                } else {
                    showAlert('error', '❌ Arquivo deve ser CSV');
                }
            });
        }
        
        console.log('✅ Módulo de Análise CSV carregado');
    </script>

    <script>
    // ✅ CORREÇÃO: Função duplicada removida - usando a versão melhorada acima
    // A função loadRiskStatus() melhorada já está definida na seção RISK MANAGEMENT FUNCTIONS
    console.log('✅ Função loadRiskStatus duplicada removida - usando versão melhorada');
    
    // Atualiza o painel a cada 10 segundos usando as funções corrigidas
    setInterval(() => {
        updateRiskDashboard(); // Função do painel unificado
    //    loadRiskPositionsMonitor(); // Função melhorada
    }, 10000);
    
    // Carregar dados iniciais usando as funções corrigidas
    updateRiskDashboard(); 
    // loadRiskPositionsMonitor();
    </script>
</body>
</html>

